<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Tripletex Business School</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .panel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .panel h2 {
            margin-bottom: 1.5rem;
            color: #667eea;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #555;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(145deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            width: 100%;
            margin-top: 1rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            width: auto;
            margin: 0.25rem;
        }

        .current-data {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid #667eea;
        }

        .player-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: #f0f0f0;
            border-radius: 6px;
        }

        .player-row input {
            width: 120px;
            margin: 0 0.5rem;
            padding: 0.25rem;
        }

        .export-area {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            min-height: 200px;
            overflow-y: auto;
        }

        .scenario-choice {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .choice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .choice-title-input {
            flex-grow: 1;
            font-weight: bold;
            color: #667eea;
            background: transparent;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 0.25rem 0.5rem;
            margin-right: 1rem;
        }

        .choice-title-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }

        .tabs {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .choice-preview {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÜ Admin Panel - Tripletex Business School</h1>
            <p>Oppdater leaderboard, scenarioer og spillerdata enkelt</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('leaderboard')">Leaderboard</button>
            <button class="tab" onclick="showTab('scenarios')">Scenarioer</button>
            <button class="tab" onclick="showTab('choices')">Se Valg</button>
            <button class="tab" onclick="showTab('penalties')">Straffer</button>
            <button class="tab" onclick="showTab('export')">Eksporter Data</button>
        </div>

        <!-- Leaderboard Tab -->
        <div id="leaderboard" class="tab-content active">
            <div class="panel-grid">
                <div class="panel">
                    <h2>üìä Oppdater Leaderboard</h2>
                    
                    <div class="current-data">
                        <strong>N√•v√¶rende rangering:</strong>
                        <div id="current-leaderboard"></div>
                    </div>

                    <div class="form-group">
                        <label>Legg til ny spiller:</label>
                        <input type="text" id="new-player-name" placeholder="Navn">
                        <input type="text" id="new-player-company" placeholder="Selskap">
                        <input type="number" id="new-player-value" placeholder="500000" value="500000">
                        <button class="btn btn-small" onclick="addPlayer()">Legg til</button>
                    </div>
                    
                    <div id="player-list"></div>
                    
                    <button class="btn" onclick="updateLeaderboard()">Oppdater Leaderboard</button>
                </div>

                <div class="panel">
                    <h2>‚ö° Hurtig Business Value Endring</h2>
                    
                    <div class="form-group">
                        <label>Velg spiller:</label>
                        <select id="quick-player-select">
                            <option value="">Velg spiller...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Endring i Business Value:</label>
                        <input type="number" id="quick-value-change" placeholder="+25000 eller -15000">
                    </div>
                    
                    <div class="form-group">
                        <label>Grunn (valgfri):</label>
                        <input type="text" id="quick-change-reason" placeholder="Scenario A suksess">
                    </div>
                    
                    <button class="btn" onclick="applyQuickChange()">Utf√∏r Endring</button>
                </div>
            </div>
        </div>

        <!-- Scenarios Tab -->
        <div id="scenarios" class="tab-content">
            <div class="panel-grid">
                <div class="panel">
                    <h2>üé≤ Aktivt Scenario</h2>
                    
                    <div class="form-group">
                        <label>Scenariotittel:</label>
                        <input type="text" id="scenario-title" placeholder="M√•ned 1: Kapasitetsutfordring">
                    </div>
                    
                    <div class="form-group">
                        <label>Beskrivelse:</label>
                        <textarea id="scenario-description" rows="3" placeholder="Din bedrift vokser raskt, men..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Deadline:</label>
                        <input type="datetime-local" id="scenario-deadline">
                    </div>
                    
                    <button class="btn" onclick="updateScenario()">Oppdater Scenario</button>
                </div>

                <div class="panel">
                    <h2>üìù Scenario Valg</h2>
                    <div id="scenario-choices">
                        <div class="scenario-choice" data-choice="A">
                            <div class="choice-header">
                                <input type="text" class="choice-title-input" value="A) Stort kontor + full bemanning" placeholder="A) Valg tittel">
                                <button class="btn btn-small" onclick="removeChoice(this)">Fjern</button>
                            </div>
                            <input type="text" class="choice-cost" placeholder="Kostnad: +80% husleie + 60k/mnd l√∏nn" style="margin-bottom: 0.5rem;">
                            <input type="text" class="choice-potential" placeholder="Potensial: Maks vekst 30% ‚Üí 50%">
                            <input type="text" class="choice-odds" placeholder="Odds: 60% suksess / 25% delvis / 15% fiasko">
                        </div>
                    </div>
                    <button class="btn btn-small" onclick="addChoice()">Legg til valg</button>
                    
                    <div class="choice-preview">
                        <h3>üìã Forh√•ndsvisning av valg:</h3>
                        <div id="choices-preview"></div>
                        <button class="btn btn-small" onclick="previewChoices()">Oppdater forh√•ndsvisning</button>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h2>üéØ Scenario Resultater</h2>
                
                <div class="form-group">
                    <label>Kast terning for alle:</label>
                    <button class="btn" onclick="rollDiceForAll()">üé≤ Kast Terning</button>
                </div>
                
                <div id="dice-results"></div>
                
                <div class="form-group">
                    <label>Eller sett resultater manuelt:</label>
                    <div id="manual-results"></div>
                </div>
                
                <button class="btn" onclick="applyScenarioResults()">Bruk Resultater</button>
            </div>
        </div>

        <!-- Choices View Tab -->
        <div id="choices" class="tab-content">
            <div class="panel">
                <h2>üëÅÔ∏è Spillervalg Oversikt</h2>
                
                <div class="form-group">
                    <label>Google Apps Script URL for √• hente valg:</label>
                    <input type="url" id="sheets-url-input" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec">
                    <button class="btn btn-small" onclick="fetchPlayerChoices()">üì• Hent Valg</button>
                </div>
                
                <div id="choices-loading" style="display: none; text-align: center; padding: 2rem;">
                    <div>‚è≥ Henter valg fra Google Sheets...</div>
                </div>
                
                <div id="choices-error" style="display: none; background: #f8d7da; border: 1px solid #dc3545; border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                    <strong>‚ùå Feil ved henting av valg:</strong>
                    <div id="error-message"></div>
                </div>
                
                <div id="choices-summary" style="display: none; background: #d4edda; border: 1px solid #28a745; border-radius: 8px; padding: 1rem; margin: 1rem 0;">
                    <div id="summary-stats"></div>
                </div>
                
                <div id="choices-content">
                    <p style="text-align: center; color: #666; font-style: italic;">Klikk "Hent Valg" for √• se spillernes valg</p>
                </div>
                
                <div style="margin-top: 2rem;">
                    <h3>üéØ Quick Actions</h3>
                    <button class="btn btn-small" onclick="exportChoicesToCSV()" id="export-csv-btn" disabled>üíæ Eksporter til CSV</button>
                    <button class="btn btn-small" onclick="clearOldChoices()" id="clear-choices-btn" disabled>üßπ Fjern Gamle Valg</button>
                    <button class="btn btn-small" onclick="refreshChoices()" id="refresh-btn" disabled>üîÑ Oppdater</button>
                </div>
            </div>
        </div>

        <!-- Penalties Tab -->
        <div id="penalties" class="tab-content">
            <div class="panel-grid">
                <div class="panel">
                    <h2>‚ö†Ô∏è Legg til Straff</h2>
                    
                    <div class="form-group">
                        <label>Spiller:</label>
                        <select id="penalty-player">
                            <option value="">Velg spiller...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Type straff:</label>
                        <select id="penalty-type">
                            <option value="">Velg type...</option>
                            <option value="setup">Setup-feil (-50,000 NOK)</option>
                            <option value="mva">MVA-feil (-25,000 NOK/dag)</option>
                            <option value="sale">Manglende salg (-10,000 NOK/dag)</option>
                            <option value="account">Feil kontokode (-5,000 NOK)</option>
                            <option value="custom">Egendefinert</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Bel√∏p (hvis egendefinert):</label>
                        <input type="number" id="penalty-amount" placeholder="-15000">
                    </div>
                    
                    <div class="form-group">
                        <label>Kommentar:</label>
                        <input type="text" id="penalty-comment" placeholder="√Örsak til straff">
                    </div>
                    
                    <button class="btn" onclick="addPenalty()">Legg til Straff</button>
                </div>

                <div class="panel">
                    <h2>üìã Aktive Straffer</h2>
                    <div id="active-penalties"></div>
                    <button class="btn" onclick="refreshPenalties()">Oppdater Liste</button>
                </div>
            </div>
        </div>

        <!-- Export Tab -->
        <div id="export" class="tab-content">
            <div class="panel">
                <h2>üì§ Eksporter Data til HTML Platform</h2>
                <p>Kopier og lim inn denne koden i den eksisterende HTML-plattformen:</p>
                
                <div class="form-group">
                    <label>JavaScript for leaderboard:</label>
                    <div class="export-area" id="export-leaderboard-js"></div>
                </div>
                
                <div class="form-group">
                    <label>JavaScript for scenario:</label>
                    <div class="export-area" id="export-scenario-js"></div>
                </div>
                
                <button class="btn" onclick="generateExportCode()">Generer Kode</button>
            </div>
        </div>
    </div>

    <script>
        // Game data - starts with sample data - MULTI-USER ENHANCED
        let gameData = {
            players: [
                { name: 'Anna Nordstr√∂m', company: 'EcoTech Solutions AS', businessValue: 545000, rank: 1 },
                { name: 'Marcus Berg', company: 'Digital Innovation AS', businessValue: 520000, rank: 2 },
                { name: 'Lisa Hansen', company: 'CreativeHub AS', businessValue: 500000, rank: 3 },
                { name: 'Test Bruker', company: 'Test Selskap AS', businessValue: 485000, rank: 4 }
            ],
            currentScenario: {
                title: 'M√•ned 1: Kapasitetsutfordring',
                description: 'Din bedrift vokser raskt, men du st√∏ter p√• kapasitetsbegrensninger...',
                deadline: '2025-08-16T14:00',
                choices: {
                    'A': 'Stort kontor + full bemanning',
                    'B': 'Medium kontor', 
                    'C': 'Automatiseringsl√∏sning',
                    'D': 'Outsourcing-strategi'
                }
            },
            penalties: [],
            // BREAKDOWN DATA FOR ALL USERS
            playerBreakdowns: {
                'Anna Nordstr√∂m': {
                    startCapital: 500000,
                    scenarioGains: [
                        { week: 1, scenario: 'Kapasitetsutfordring', choice: 'A', outcome: 'Suksess!', value: 35000 },
                        { week: 2, scenario: 'Markedsf√∏ring', choice: 'B', outcome: 'Moderat', value: 10000 }
                    ],
                    penalties: [],
                    bonuses: []
                },
                'Marcus Berg': {
                    startCapital: 500000,
                    scenarioGains: [
                        { week: 1, scenario: 'Kapasitetsutfordring', choice: 'B', outcome: 'Suksess', value: 20000 }
                    ],
                    penalties: [],
                    bonuses: []
                },
                'Lisa Hansen': {
                    startCapital: 500000,
                    scenarioGains: [],
                    penalties: [],
                    bonuses: []
                },
                'Test Bruker': {
                    startCapital: 500000,
                    scenarioGains: [
                        { week: 1, scenario: 'Kapasitetsutfordring', choice: 'A', outcome: 'Suksess', value: 25000 },
                        { week: 2, scenario: 'Markedsf√∏ring', choice: 'C', outcome: 'Moderat', value: 15000 }
                    ],
                    penalties: [
                        { type: 'MVA-feil', value: -25000, date: '2025-08-10', status: 'aktiv', reason: 'Feil MVA-kode p√• salg' },
                        { type: 'Setup-feil', value: -50000, date: '2025-08-05', status: 'l√∏st', reason: 'Feil √•pningsbalanse' }
                    ],
                    bonuses: [
                        { type: 'Cleanup bonus', value: 15000, date: '2025-08-12', reason: 'Rettet alle setup-feil raskt' }
                    ]
                }
            }
        };

        // Tab functionality
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Refresh data for the tab
            if (tabName === 'leaderboard') {
                refreshLeaderboard();
            } else if (tabName === 'penalties') {
                refreshPenalties();
            } else if (tabName === 'scenarios') {
                previewChoices(); // Auto-update preview when switching to scenarios
            } else if (tabName === 'choices') {
                // Auto-load choices if URL is set
                const urlInput = document.getElementById('sheets-url-input');
                if (urlInput.value && !urlInput.value.includes('YOUR_SCRIPT_ID')) {
                    fetchPlayerChoices();
                }
            }
        }

        // Leaderboard functions
        function refreshLeaderboard() {
            // Sort players by business value
            gameData.players.sort((a, b) => b.businessValue - a.businessValue);
            
            // Update ranks
            gameData.players.forEach((player, index) => {
                player.rank = index + 1;
            });
            
            // Update current leaderboard display
            const currentDiv = document.getElementById('current-leaderboard');
            currentDiv.innerHTML = gameData.players.map(player => 
                `${player.rank}. ${player.name} - ${player.businessValue.toLocaleString()} NOK`
            ).join('<br>');
            
            // Update player list for editing
            const playerListDiv = document.getElementById('player-list');
            playerListDiv.innerHTML = gameData.players.map((player, index) => `
                <div class="player-row">
                    <span>${player.rank}. ${player.name}</span>
                    <div>
                        <input type="number" value="${player.businessValue}" 
                               onchange="updatePlayerValue(${index}, this.value)">
                        <button class="btn btn-small" onclick="removePlayer(${index})">Fjern</button>
                    </div>
                </div>
            `).join('');
            
            // Update dropdowns
            updatePlayerDropdowns();
        }

        function updatePlayerDropdowns() {
            const dropdowns = ['quick-player-select', 'penalty-player'];
            dropdowns.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                dropdown.innerHTML = '<option value="">Velg spiller...</option>' +
                    gameData.players.map((player, index) => 
                        `<option value="${index}">${player.name}</option>`
                    ).join('');
            });
        }

        function addPlayer() {
            const name = document.getElementById('new-player-name').value;
            const company = document.getElementById('new-player-company').value;
            const value = parseInt(document.getElementById('new-player-value').value);
            
            if (name && company && value) {
                gameData.players.push({
                    name,
                    company,
                    businessValue: value,
                    rank: gameData.players.length + 1
                });
                
                // Clear inputs
                document.getElementById('new-player-name').value = '';
                document.getElementById('new-player-company').value = '';
                document.getElementById('new-player-value').value = '500000';
                
                refreshLeaderboard();
                alert(`${name} lagt til!`);
            } else {
                alert('Fyll inn alle felt');
            }
        }

        function removePlayer(index) {
            if (confirm(`Sikker p√• at du vil fjerne ${gameData.players[index].name}?`)) {
                gameData.players.splice(index, 1);
                refreshLeaderboard();
            }
        }

        function updatePlayerValue(index, newValue) {
            gameData.players[index].businessValue = parseInt(newValue);
            refreshLeaderboard();
        }

        function applyQuickChange() {
            const playerIndex = document.getElementById('quick-player-select').value;
            const change = parseInt(document.getElementById('quick-value-change').value);
            const reason = document.getElementById('quick-change-reason').value;
            
            if (playerIndex !== '' && change) {
                gameData.players[playerIndex].businessValue += change;
                
                // Clear inputs
                document.getElementById('quick-player-select').value = '';
                document.getElementById('quick-value-change').value = '';
                document.getElementById('quick-change-reason').value = '';
                
                refreshLeaderboard();
                alert(`Endring p√• ${change.toLocaleString()} NOK utf√∏rt for ${gameData.players[playerIndex].name}`);
            } else {
                alert('Velg spiller og angi endring');
            }
        }

        function updateLeaderboard() {
            alert('Leaderboard oppdatert! Kopier JavaScript-koden fra "Eksporter Data" fanen.');
        }

        // FIXED Scenario functions
        function updateScenario() {
            gameData.currentScenario.title = document.getElementById('scenario-title').value;
            gameData.currentScenario.description = document.getElementById('scenario-description').value;
            gameData.currentScenario.deadline = document.getElementById('scenario-deadline').value;
            
            // Collect choices from the form
            collectChoicesData();
            
            alert('Scenario oppdatert!');
        }

        function collectChoicesData() {
            const choiceElements = document.querySelectorAll('.scenario-choice');
            const choices = {};
            
            choiceElements.forEach(choiceEl => {
                const titleInput = choiceEl.querySelector('.choice-title-input');
                const costInput = choiceEl.querySelector('.choice-cost');
                const potentialInput = choiceEl.querySelector('.choice-potential');
                const oddsInput = choiceEl.querySelector('.choice-odds');
                
                if (titleInput && titleInput.value.trim()) {
                    // Extract letter from title (A), B), C), etc.)
                    const titleValue = titleInput.value.trim();
                    const letterMatch = titleValue.match(/^([A-Z])\)/);
                    const letter = letterMatch ? letterMatch[1] : 'A';
                    const title = titleValue.replace(/^[A-Z]\)\s*/, ''); // Remove "A) " part
                    
                    choices[letter] = {
                        title: title,
                        cost: costInput ? costInput.value.trim() : '',
                        potential: potentialInput ? potentialInput.value.trim() : '',
                        odds: oddsInput ? oddsInput.value.trim() : ''
                    };
                }
            });
            
            gameData.currentScenario.choices = choices;
            console.log('Collected choices:', choices);
        }

        function addChoice() {
            const choicesDiv = document.getElementById('scenario-choices');
            const choiceCount = choicesDiv.children.length;
            const choiceLetter = String.fromCharCode(65 + choiceCount); // A, B, C, D...
            
            const choiceDiv = document.createElement('div');
            choiceDiv.className = 'scenario-choice';
            choiceDiv.setAttribute('data-choice', choiceLetter);
            choiceDiv.innerHTML = `
                <div class="choice-header">
                    <input type="text" class="choice-title-input" value="${choiceLetter}) Nytt valg" placeholder="${choiceLetter}) Valg tittel" oninput="previewChoices()">
                    <button class="btn btn-small" onclick="removeChoice(this)">Fjern</button>
                </div>
                <input type="text" class="choice-cost" placeholder="Kostnad: " style="margin-bottom: 0.5rem;" oninput="previewChoices()">
                <input type="text" class="choice-potential" placeholder="Potensial: " style="margin-bottom: 0.5rem;" oninput="previewChoices()">
                <input type="text" class="choice-odds" placeholder="Odds: " oninput="previewChoices()">
            `;
            choicesDiv.appendChild(choiceDiv);
            
            // Auto-update preview
            setTimeout(previewChoices, 100);
        }

        function removeChoice(button) {
            button.closest('.scenario-choice').remove();
            previewChoices();
        }

        // NEW: Preview choices function
        function previewChoices() {
            collectChoicesData(); // Update gameData with current form values
            
            const previewDiv = document.getElementById('choices-preview');
            const choices = gameData.currentScenario.choices;
            
            if (!choices || Object.keys(choices).length === 0) {
                previewDiv.innerHTML = '<p>Ingen valg lagt til enn√•</p>';
                return;
            }
            
            let html = '';
            Object.entries(choices).forEach(([key, choice]) => {
                html += `
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem; background: white;">
                        <div style="font-weight: bold; color: #667eea; margin-bottom: 0.5rem;">${key}) ${choice.title}</div>
                        ${choice.cost ? `<div style="color: #dc3545; font-size: 0.9rem;">üí∞ ${choice.cost}</div>` : ''}
                        ${choice.potential ? `<div style="color: #28a745; font-size: 0.9rem;">üéØ ${choice.potential}</div>` : ''}
                        ${choice.odds ? `<div style="color: #666; font-size: 0.9rem;">üé≤ ${choice.odds}</div>` : ''}
                    </div>
                `;
            });
            
            previewDiv.innerHTML = html;
        }

        function rollDiceForAll() {
            const resultsDiv = document.getElementById('dice-results');
            let results = '<h3>üé≤ Terningkast Resultater:</h3>';
            
            gameData.players.forEach(player => {
                const roll = Math.floor(Math.random() * 6) + 1;
                results += `<p><strong>${player.name}:</strong> Terning ${roll}</p>`;
            });
            
            resultsDiv.innerHTML = results;
        }

        function applyScenarioResults() {
            alert('Scenario resultater anvendt! Husk √• oppdatere business values manuelt.');
        }

        // Penalty functions
        function addPenalty() {
            const playerIndex = document.getElementById('penalty-player').value;
            const penaltyType = document.getElementById('penalty-type').value;
            const customAmount = document.getElementById('penalty-amount').value;
            const comment = document.getElementById('penalty-comment').value;
            
            if (playerIndex !== '' && penaltyType) {
                let amount = 0;
                let description = '';
                
                switch(penaltyType) {
                    case 'setup':
                        amount = -50000;
                        description = 'Setup-feil';
                        break;
                    case 'mva':
                        amount = -25000;
                        description = 'MVA-feil';
                        break;
                    case 'sale':
                        amount = -10000;
                        description = 'Manglende salg';
                        break;
                    case 'account':
                        amount = -5000;
                        description = 'Feil kontokode';
                        break;
                    case 'custom':
                        amount = parseInt(customAmount);
                        description = 'Egendefinert straff';
                        break;
                }
                
                const player = gameData.players[playerIndex];
                const penalty = {
                    player: player.name,
                    type: description,
                    amount: amount,
                    comment: comment,
                    date: new Date().toLocaleDateString()
                };
                
                gameData.penalties.push(penalty);
                
                // Apply penalty to business value
                player.businessValue += amount;
                
                // IMPORTANT: Add to player's breakdown data
                if (!gameData.playerBreakdowns[player.name]) {
                    gameData.playerBreakdowns[player.name] = {
                        startCapital: 500000,
                        scenarioGains: [],
                        penalties: [],
                        bonuses: []
                    };
                }
                
                gameData.playerBreakdowns[player.name].penalties.push({
                    type: description,
                    value: amount,
                    date: new Date().toLocaleDateString(),
                    status: 'aktiv',
                    reason: comment || 'Ingen kommentar'
                });
                
                // Clear form
                document.getElementById('penalty-player').value = '';
                document.getElementById('penalty-type').value = '';
                document.getElementById('penalty-amount').value = '';
                document.getElementById('penalty-comment').value = '';
                
                refreshLeaderboard();
                refreshPenalties();
                alert(`Straff p√• ${amount.toLocaleString()} NOK lagt til for ${penalty.player}.\n\nHusk √• eksportere og oppdatere hovedsiden!`);
            } else {
                alert('Velg spiller og type straff');
            }
        }

        function refreshPenalties() {
            const penaltiesDiv = document.getElementById('active-penalties');
            if (gameData.penalties.length === 0) {
                penaltiesDiv.innerHTML = '<p>Ingen aktive straffer</p>';
            } else {
                penaltiesDiv.innerHTML = gameData.penalties.map((penalty, index) => `
                    <div class="player-row">
                        <div>
                            <strong>${penalty.player}</strong><br>
                            ${penalty.type}: ${penalty.amount.toLocaleString()} NOK<br>
                            <small>${penalty.comment} (${penalty.date})</small>
                        </div>
                        <button class="btn btn-small" onclick="removePenalty(${index})">Fjern</button>
                    </div>
                `).join('');
            }
        }

        function removePenalty(index) {
            const penalty = gameData.penalties[index];
            if (confirm(`Fjern straff for ${penalty.player}?`)) {
                // Remove penalty from business value (add it back)
                const playerIndex = gameData.players.findIndex(p => p.name === penalty.player);
                if (playerIndex !== -1) {
                    gameData.players[playerIndex].businessValue -= penalty.amount; // subtract negative = add
                }
                
                gameData.penalties.splice(index, 1);
                refreshLeaderboard();
                refreshPenalties();
            }
        }

        // FIXED EXPORT FUNCTION with Google Sheets Integration
        function generateExportCode() {
            // Ensure we have players data
            if (!gameData.players || gameData.players.length === 0) {
                alert('Legg til spillere f√∏rst!');
                return;
            }
            
            // IMPORTANT: Set your Google Apps Script URL here!
            const GOOGLE_SHEETS_URL = prompt(
                'Lim inn din Google Apps Script Web App URL:\n\n' +
                '(F√∏lg instruksjonen i "Eksporter Data" fanen for √• f√• denne)',
                'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec'
            );
            
            if (!GOOGLE_SHEETS_URL || GOOGLE_SHEETS_URL.includes('YOUR_SCRIPT_ID')) {
                alert('Du m√• sette opp Google Apps Script URL f√∏rst!');
                return;
            }
            
            // Collect current choices from the form before generating export
            collectChoicesData();
            
            // Generate leaderboard update code
            const leaderboardCode = `
// Oppdater leaderboard data
window.updateGameData({
    players: ${JSON.stringify(gameData.players, null, 2)},
    playerBreakdowns: ${JSON.stringify(gameData.playerBreakdowns, null, 2)}
});

console.log('Leaderboard updated successfully!');`;

            // Generate scenario code with Google Sheets Integration (CORS-fixed)
            const scenarioCode = `
// Oppdater scenario data med Google Sheets integration (CORS-fixed)
const GOOGLE_SHEETS_URL = '${GOOGLE_SHEETS_URL}';

const scenarioData = {
    title: "${gameData.currentScenario.title}",
    description: "${gameData.currentScenario.description}",
    deadline: "${gameData.currentScenario.deadline}",
    choices: ${JSON.stringify(gameData.currentScenario.choices, null, 2)}
};

// Function to send choice to Google Sheets using JSONP (bypasses CORS)
function sendChoiceToSheets(choiceData) {
    return new Promise((resolve, reject) => {
        // Create a unique callback name
        const callbackName = 'jsonpCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
        
        // Create the script element
        const script = document.createElement('script');
        
        // Set up the callback function
        window[callbackName] = function(response) {
            // Clean up
            document.head.removeChild(script);
            delete window[callbackName];
            
            if (response && response.status === 'success') {
                resolve(true);
            } else {
                reject(new Error(response ? response.message : 'Unknown error'));
            }
        };
        
        // Handle script load error
        script.onerror = function() {
            document.head.removeChild(script);
            delete window[callbackName];
            reject(new Error('Failed to load script'));
        };
        
        // Encode the data for URL
        const params = new URLSearchParams({
            callback: callbackName,
            player: choiceData.player,
            choice: choiceData.choice,
            choiceTitle: choiceData.choiceTitle,
            scenarioTitle: choiceData.scenarioTitle,
            week: choiceData.week,
            timestamp: choiceData.timestamp
        });
        
        // Set the script source
        script.src = GOOGLE_SHEETS_URL + '?' + params.toString();
        
        // Add script to head to trigger the request
        document.head.appendChild(script);
        
        // Set a timeout in case the request hangs
        setTimeout(() => {
            if (document.head.contains(script)) {
                document.head.removeChild(script);
                delete window[callbackName];
                reject(new Error('Request timeout'));
            }
        }, 10000); // 10 second timeout
    });
}

// Update scenario with clickable choices
window.updateGameData({
    scenario: scenarioData
});

// Make choices clickable and integrate with Google Sheets
setTimeout(() => {
    const choiceElements = document.querySelectorAll('.choice-display');
    choiceElements.forEach((choiceEl, index) => {
        const choiceLetter = choiceEl.querySelector('.choice-letter').textContent.replace(')', '');
        
        // Add click handler
        choiceEl.style.cursor = 'pointer';
        choiceEl.style.transition = 'all 0.3s ease';
        
        choiceEl.addEventListener('mouseenter', () => {
            choiceEl.style.transform = 'translateX(5px)';
            choiceEl.style.boxShadow = '0 4px 15px rgba(0,0,0,0.1)';
        });
        
        choiceEl.addEventListener('mouseleave', () => {
            choiceEl.style.transform = 'translateX(0)';
            choiceEl.style.boxShadow = 'none';
        });
        
        choiceEl.addEventListener('click', async () => {
            const playerName = prompt('Skriv inn ditt navn for √• velge dette alternativet:');
            if (playerName && playerName.trim()) {
                const choiceTitle = choiceEl.querySelector('.choice-title').textContent;
                const confirmed = confirm(\`\${playerName}, bekrefter du valg \${choiceLetter}: \${choiceTitle}?\`);
                
                if (confirmed) {
                    // Show loading state
                    const originalBg = choiceEl.style.backgroundColor;
                    choiceEl.style.backgroundColor = '#fff3cd';
                    choiceEl.style.borderColor = '#ffc107';
                    
                    // Add loading text
                    const loadingEl = document.createElement('div');
                    loadingEl.innerHTML = '‚è≥ Sender valg...';
                    loadingEl.style.cssText = 'font-size: 0.8rem; color: #856404; margin-top: 0.5rem; font-weight: bold;';
                    choiceEl.appendChild(loadingEl);
                    
                    // Prepare choice data
                    const choiceData = {
                        player: playerName.trim(),
                        choice: choiceLetter,
                        choiceTitle: choiceTitle,
                        scenarioTitle: scenarioData.title,
                        week: 'Current',
                        timestamp: new Date().toISOString()
                    };
                    
                    try {
                        // Send to Google Sheets using JSONP
                        await sendChoiceToSheets(choiceData);
                        
                        // Remove loading element
                        choiceEl.removeChild(loadingEl);
                        
                        // Success feedback
                        choiceEl.style.backgroundColor = '#d4edda';
                        choiceEl.style.borderColor = '#28a745';
                        
                        alert(\`‚úÖ Valg registrert: \${choiceLetter}) \${choiceTitle}\\n\\nDitt valg er sendt til admin og lagret i systemet!\`);
                        
                        // Add success indicator
                        const successEl = document.createElement('div');
                        successEl.innerHTML = '‚úÖ Valg registrert!';
                        successEl.style.cssText = 'font-size: 0.8rem; color: #155724; margin-top: 0.5rem; font-weight: bold;';
                        choiceEl.appendChild(successEl);
                        
                        // Disable further clicking
                        choiceEl.style.pointerEvents = 'none';
                        choiceEl.style.opacity = '0.8';
                        
                    } catch (error) {
                        console.error('Error sending choice:', error);
                        
                        // Remove loading element
                        if (choiceEl.contains(loadingEl)) {
                            choiceEl.removeChild(loadingEl);
                        }
                        
                        // Error feedback
                        choiceEl.style.backgroundColor = '#f8d7da';
                        choiceEl.style.borderColor = '#dc3545';
                        
                        alert('‚ùå Feil ved sending av valg: ' + error.message + '\\n\\nPr√∏v igjen eller kontakt admin.');
                        
                        // Reset to original state
                        setTimeout(() => {
                            choiceEl.style.backgroundColor = originalBg;
                            choiceEl.style.borderColor = '';
                        }, 3000);
                    }
                }
            }
        });
        
        // Add visual indication that choices are clickable
        const choiceContent = choiceEl.querySelector('.choice-content');
        if (choiceContent) {
            const clickHint = document.createElement('div');
            clickHint.innerHTML = 'üëÜ Klikk for √• velge';
            clickHint.style.cssText = 'font-size: 0.8rem; color: #667eea; margin-top: 0.5rem; opacity: 0.7;';
            choiceContent.appendChild(clickHint);
        }
    });
}, 500);

console.log('Scenario updated with Google Sheets integration (CORS-fixed)!');`;

            document.getElementById('export-leaderboard-js').textContent = leaderboardCode;
            document.getElementById('export-scenario-js').textContent = scenarioCode;
            
            console.log('Generated export code with Google Sheets integration');
            alert('Kode generert med Google Sheets integration! \\n\\nHusk √• f√∏lge instruksjonene for √• sette opp Google Apps Script f√∏rst.');
        }

        // NEW: Player Choices Management
        let currentChoicesData = [];

        function fetchPlayerChoices() {
            const urlInput = document.getElementById('sheets-url-input');
            const sheetsUrl = urlInput.value.trim();
            
            if (!sheetsUrl || sheetsUrl.includes('YOUR_SCRIPT_ID')) {
                alert('Legg inn din Google Apps Script URL f√∏rst!');
                return;
            }
            
            // Show loading
            document.getElementById('choices-loading').style.display = 'block';
            document.getElementById('choices-error').style.display = 'none';
            document.getElementById('choices-summary').style.display = 'none';
            document.getElementById('choices-content').innerHTML = '<p style="text-align: center; color: #666;">Laster...</p>';
            
            // Fetch choices using JSONP
            fetchChoicesFromSheets(sheetsUrl)
                .then(data => {
                    document.getElementById('choices-loading').style.display = 'none';
                    currentChoicesData = data;
                    displayChoicesData(data);
                    enableActionButtons();
                })
                .catch(error => {
                    document.getElementById('choices-loading').style.display = 'none';
                    showChoicesError(error.message);
                });
        }

        function fetchChoicesFromSheets(url) {
            return new Promise((resolve, reject) => {
                const callbackName = 'choicesCallback_' + Date.now();
                const script = document.createElement('script');
                
                window[callbackName] = function(response) {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    
                    if (response && response.status === 'success') {
                        resolve(response.data || []);
                    } else {
                        reject(new Error(response ? response.message : 'Unknown error'));
                    }
                };
                
                script.onerror = function() {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    reject(new Error('Failed to fetch choices from Google Sheets'));
                };
                
                script.src = url + '?callback=' + callbackName;
                document.head.appendChild(script);
                
                setTimeout(() => {
                    if (document.head.contains(script)) {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        reject(new Error('Request timeout'));
                    }
                }, 10000);
            });
        }

        function displayChoicesData(data) {
            if (!data || data.length === 0) {
                document.getElementById('choices-content').innerHTML = `
                    <div style="text-align: center; padding: 2rem; background: #f8f9fa; border-radius: 8px;">
                        <h3>üì≠ Ingen valg funnet</h3>
                        <p>Enten har ingen valgt enn√•, eller Google Sheets er tomt.</p>
                    </div>
                `;
                return;
            }
            
            // Show summary
            showChoicesSummary(data);
            
            // Group by scenario
            const groupedByScenario = {};
            data.forEach(choice => {
                const scenario = choice['Scenario Title'] || 'Ukjent Scenario';
                if (!groupedByScenario[scenario]) {
                    groupedByScenario[scenario] = [];
                }
                groupedByScenario[scenario].push(choice);
            });
            
            let html = '';
            Object.entries(groupedByScenario).forEach(([scenario, choices]) => {
                html += `
                    <div style="background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h3 style="color: #667eea; margin-bottom: 1rem; border-bottom: 2px solid #f0f0f0; padding-bottom: 0.5rem;">
                            üé≤ ${scenario}
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                `;
                
                choices.forEach(choice => {
                    const timestamp = new Date(choice['Timestamp']).toLocaleDateString('no-NO') + ' ' + 
                                    new Date(choice['Timestamp']).toLocaleTimeString('no-NO', {hour: '2-digit', minute: '2-digit'});
                    
                    html += `
                        <div style="background: #f8f9fa; border-radius: 8px; padding: 1rem; border-left: 4px solid #667eea;">
                            <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 0.5rem;">
                                <strong style="color: #667eea; font-size: 1.1rem;">${choice['Player Name']}</strong>
                                <span style="background: #667eea; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: bold;">
                                    ${choice['Choice Letter']}
                                </span>
                            </div>
                            <div style="color: #333; margin-bottom: 0.5rem;">${choice['Choice Title']}</div>
                            <div style="color: #666; font-size: 0.85rem;">‚è∞ ${timestamp}</div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('choices-content').innerHTML = html;
        }

        function showChoicesSummary(data) {
            const totalChoices = data.length;
            const uniquePlayers = new Set(data.map(choice => choice['Player Name'])).size;
            const scenarios = new Set(data.map(choice => choice['Scenario Title'])).size;
            
            // Count choices by letter
            const choiceCounts = {};
            data.forEach(choice => {
                const letter = choice['Choice Letter'];
                choiceCounts[letter] = (choiceCounts[letter] || 0) + 1;
            });
            
            const choiceBreakdown = Object.entries(choiceCounts)
                .sort(([a], [b]) => a.localeCompare(b))
                .map(([letter, count]) => `${letter}: ${count}`)
                .join(' | ');
            
            document.getElementById('summary-stats').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                    <div><strong>üìä Totalt valg:</strong> ${totalChoices}</div>
                    <div><strong>üë• Unike spillere:</strong> ${uniquePlayers}</div>
                    <div><strong>üéØ Scenarioer:</strong> ${scenarios}</div>
                </div>
                <div><strong>üìà Valg fordeling:</strong> ${choiceBreakdown}</div>
            `;
            document.getElementById('choices-summary').style.display = 'block';
        }

        function showChoicesError(message) {
            document.getElementById('error-message').textContent = message;
            document.getElementById('choices-error').style.display = 'block';
            document.getElementById('choices-content').innerHTML = '<p style="text-align: center; color: #dc3545;">Kunne ikke hente valg</p>';
        }

        function enableActionButtons() {
            document.getElementById('export-csv-btn').disabled = false;
            document.getElementById('clear-choices-btn').disabled = false;
            document.getElementById('refresh-btn').disabled = false;
        }

        function refreshChoices() {
            fetchPlayerChoices();
        }

        function exportChoicesToCSV() {
            if (currentChoicesData.length === 0) {
                alert('Ingen data √• eksportere');
                return;
            }
            
            // Create CSV content
            const headers = ['Timestamp', 'Player Name', 'Choice Letter', 'Choice Title', 'Scenario Title', 'Session/Week'];
            let csvContent = headers.join(',') + '\\n';
            
            currentChoicesData.forEach(choice => {
                const row = [
                    choice['Timestamp'],
                    '"' + choice['Player Name'] + '"',
                    choice['Choice Letter'],
                    '"' + choice['Choice Title'] + '"',
                    '"' + (choice['Scenario Title'] || 'N/A') + '"',
                    choice['Session/Week'] || 'N/A'
                ];
                csvContent += row.join(',') + '\\n';
            });
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tripletex_choices_' + new Date().toISOString().split('T')[0] + '.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('CSV eksportert! üìÅ');
        }

        function clearOldChoices() {
            const confirmed = confirm('Er du sikker p√• at du vil fjerne alle gamle valg fra visningen?\\n\\nDette p√•virker IKKE Google Sheets, bare denne visningen.');
            
            if (confirmed) {
                currentChoicesData = [];
                document.getElementById('choices-content').innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">Visning t√∏mt. Klikk "Hent Valg" for √• laste p√• nytt.</p>';
                document.getElementById('choices-summary').style.display = 'none';
                
                // Disable action buttons
                document.getElementById('export-csv-btn').disabled = true;
                document.getElementById('clear-choices-btn').disabled = true;
                document.getElementById('refresh-btn').disabled = true;
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            refreshLeaderboard();
            
            // Set current date/time for scenario deadline
            const now = new Date();
            now.setDate(now.getDate() + 2); // 2 days from now
            document.getElementById('scenario-deadline').value = now.toISOString().slice(0, 16);
            
            // Fill scenario with default data
            document.getElementById('scenario-title').value = gameData.currentScenario.title;
            document.getElementById('scenario-description').value = gameData.currentScenario.description;
            
            // Auto-generate preview
            previewChoices();
        });
    </script>
</body>
</html>
