<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suppa Business League</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #3B82F6 0%, #00A651 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 0;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: #3B82F6;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .nav-links a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s ease;
            cursor: pointer;
        }

        .nav-links a:hover, .nav-links a.active {
            color: #3B82F6;
        }

        .main-content {
            padding: 2rem 0;
        }

        .dashboard {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(145deg, #f0f0f0, #ffffff);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #3B82F6;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .leaderboard {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .leaderboard h2 {
            margin-bottom: 1.5rem;
            color: #333;
            text-align: center;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(145deg, #f9f9f9, #ffffff);
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .leaderboard-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .rank {
            font-weight: bold;
            font-size: 1.2rem;
            color: #3B82F6;
            min-width: 40px;
        }

        .rank.gold { color: #FFD700; }
        .rank.silver { color: #C0C0C0; }
        .rank.bronze { color: #CD7F32; }

        .player-info {
            flex-grow: 1;
            margin-left: 1rem;
        }

        .player-name {
            font-weight: bold;
            margin-bottom: 0.2rem;
        }

        .player-company {
            color: #666;
            font-size: 0.9rem;
        }

        .business-value {
            font-weight: bold;
            color: #28a745;
            font-size: 1.1rem;
        }

        .breakdown {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-top: 0.5rem;
            padding: 1rem;
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        .breakdown.visible {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
                padding: 0 1rem;
            }
            to {
                opacity: 1;
                max-height: 500px;
                padding: 1rem;
            }
        }

        .breakdown-section {
            margin-bottom: 1rem;
            border-left: 3px solid #3B82F6;
            padding-left: 1rem;
        }

        .breakdown-section:last-child {
            margin-bottom: 0;
        }

        .breakdown-title {
            font-weight: bold;
            color: #3B82F6;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            border-bottom: 1px solid #e9ecef;
        }

        .breakdown-item:last-child {
            border-bottom: none;
        }

        .breakdown-item.positive {
            color: #28a745;
        }

        .breakdown-item.negative {
            color: #dc3545;
        }

        .breakdown-item.neutral {
            color: #6c757d;
        }

        .breakdown-total {
            background: #3B82F6;
            color: white;
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            font-weight: bold;
            text-align: center;
        }

        .scenario-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .scenario-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .scenario-deadline {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: bold;
        }

        /* Accounting table styling */
        .accounting-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.9rem;
            background: white;
        }

        .accounting-table th,
        .accounting-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .accounting-table th {
            background: #f8f9ff;
            font-weight: bold;
            color: #3B82F6;
            border-bottom: 2px solid #3B82F6;
        }

        .accounting-table .amount {
            text-align: right;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        /* Task styling */
        .scenario-tasks {
            margin: 1.5rem 0;
        }

        .task-display {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(145deg, #f8f9ff, #ffffff);
            border-radius: 12px;
            border-left: 4px solid #3B82F6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .task-display:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .task-number {
            font-weight: bold;
            font-size: 1.3rem;
            color: #3B82F6;
            min-width: 35px;
            background: rgba(0, 102, 204, 0.1);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .task-content {
            flex-grow: 1;
        }

        .task-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .task-description {
            color: #666;
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }

        .task-rewards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .task-reward {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
            font-weight: bold;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.9rem;
            border: 1px solid rgba(40, 167, 69, 0.2);
        }

        .task-penalty {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            font-weight: bold;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.9rem;
            border: 1px solid rgba(220, 53, 69, 0.2);
        }

        .scenario-choices {
            margin: 1.5rem 0;
        }

        .choice-display {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background: linear-gradient(145deg, #f9f9f9, #ffffff);
            border-radius: 8px;
            border-left: 4px solid #3B82F6;
        }

        .choice-letter {
            font-weight: bold;
            font-size: 1.2rem;
            color: #3B82F6;
            min-width: 30px;
        }

        .choice-content {
            flex-grow: 1;
        }

        .choice-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .choice-cost {
            color: #dc3545;
            font-weight: bold;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .choice-potential {
            color: #28a745;
            font-weight: bold;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .choice-odds {
            color: #666;
            font-size: 0.85rem;
        }

        .scenario-note {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .scenario-note p {
            margin-bottom: 0.5rem;
        }

        .scenario-note p:last-child {
            margin-bottom: 0;
        }

        /* EMERGENCY CSS OVERRIDES - Cleaned up colors */
        #scenario-content .scenario-results,
        .scenario-section .scenario-results,
        .scenario-card .scenario-results {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
            z-index: 999 !important;
            margin-top: 2rem !important;
            background: linear-gradient(145deg, #f0f8ff, #e8f4f8) !important;
            border-radius: 12px !important;
            padding: 2rem !important;
            border: 2px solid #3B82F6 !important; /* Normal blue border */
            box-shadow: 0 4px 20px rgba(0,0,0,0.1) !important;
            width: 100% !important;
            height: auto !important;
            max-width: none !important;
            min-height: 200px !important;
        }

        #scenario-content .scenario-results h3,
        .scenario-section .scenario-results h3,
        .scenario-card .scenario-results h3 {
            display: block !important;
            visibility: visible !important;
            color: #3B82F6 !important; /* Normal blue text */
            margin-bottom: 1.5rem !important;
            text-align: center !important;
            font-size: 1.5rem !important;
            font-weight: bold !important;
        }

        #scenario-content .results-grid,
        .scenario-section .results-grid,
        .scenario-card .results-grid {
            display: grid !important;
            visibility: visible !important;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)) !important;
            gap: 1.5rem !important;
            margin: 1.5rem 0 !important;
            width: 100% !important;
        }

        #scenario-content .result-item,
        .scenario-section .result-item,
        .scenario-card .result-item {
            display: block !important;
            visibility: visible !important;
            background: white !important; /* Normal white background */
            border-radius: 12px !important;
            padding: 1.5rem !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
            border-left: 6px solid #3B82F6 !important; /* Normal blue border */
            margin-bottom: 1rem !important;
            min-height: 150px !important;
        }

        .results-grid {
            display: grid !important;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)) !important;
            gap: 1.5rem !important;
            margin: 1.5rem 0 !important;
        }

        .result-item {
            background: white !important;
            border-radius: 12px !important;
            padding: 1.5rem !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
            border-left: 6px solid #3B82F6 !important;
            transition: transform 0.3s ease !important;
            display: block !important; /* FORCE VISIBILITY */
            visibility: visible !important; /* FORCE VISIBILITY */
        }

        .result-item:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 6px 25px rgba(0,0,0,0.15) !important;
        }

        .result-player {
            font-weight: bold !important;
            font-size: 1.2rem !important;
            margin-bottom: 0.75rem !important;
            color: #3B82F6 !important;
            text-align: center !important;
            display: block !important;
        }

        .result-choice, .result-dice, .result-outcome {
            margin-bottom: 0.5rem !important;
            font-size: 0.95rem !important;
            color: #555 !important;
            display: block !important;
        }

        .result-outcome {
            font-weight: bold !important;
            padding: 0.5rem !important;
            border-radius: 6px !important;
            text-align: center !important;
            margin: 0.75rem 0 !important;
            display: block !important;
        }

        .result-outcome.success {
            background: rgba(40, 167, 69, 0.1) !important;
            color: #28a745 !important;
            border: 1px solid rgba(40, 167, 69, 0.3) !important;
        }

        .result-outcome.failure {
            background: rgba(220, 53, 69, 0.1) !important;
            color: #dc3545 !important;
            border: 1px solid rgba(220, 53, 69, 0.3) !important;
        }

        .result-outcome.moderate {
            background: rgba(255, 193, 7, 0.1) !important;
            color: #856404 !important;
            border: 1px solid rgba(255, 193, 7, 0.3) !important;
        }

        .result-value {
            font-weight: bold !important;
            font-size: 1.3rem !important;
            margin-top: 1rem !important;
            text-align: center !important;
            padding: 0.75rem !important;
            border-radius: 8px !important;
            display: block !important;
        }

        .result-value.positive {
            background: rgba(40, 167, 69, 0.1) !important;
            color: #28a745 !important;
            border: 2px solid #28a745 !important;
        }

        .result-value.negative {
            background: rgba(220, 53, 69, 0.1) !important;
            color: #dc3545 !important;
            border: 2px solid #dc3545 !important;
        }

        .btn {
            background: linear-gradient(145deg, #3B82F6, #00A651);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .notification {
            background: #cce7ff;
            border: 1px solid #99d6ff;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hidden {
            display: none;
        }

        /* Connection status indicator */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 0.75rem 1rem;
            border-radius: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            font-size: 0.85rem;
            font-weight: 500;
            z-index: 1000;
            transition: all 0.3s ease;
            border: 2px solid #e0e0e0;
            min-width: 180px;
            text-align: center;
        }

        .connection-status.connected {
            color: #28a745;
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }

        .connection-status.loading {
            color: #ffc107;
            border-color: #ffc107;
            background: rgba(255, 193, 7, 0.1);
        }

        .connection-status.error {
            color: #dc3545;
            border-color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            .nav {
                flex-direction: column;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .task-display {
                flex-direction: column;
                gap: 0.75rem;
            }

            .task-number {
                align-self: flex-start;
            }

            .task-rewards {
                grid-template-columns: 1fr;
            }

            .connection-status {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 1rem;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Task description styling */
        .task-description ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }

        .task-description li {
            margin-bottom: 0.25rem;
        }

        .task-description strong {
            color: #495057;
            font-weight: 600;
        }

        .task-description,
        .task-content {
            background: #f8f9ff !important;
            color: #2c3e50 !important;
            border: 1px solid #e3f2fd !important;
            border-radius: 6px !important;
            padding: 0.75rem !important;
            white-space: pre-line !important;
            line-height: 1.5 !important;
        }

        .scenario-card {
            padding: 3rem !important;
            line-height: 1.6 !important;
        }

        .scenario-card h2 {
            margin-bottom: 2rem !important;
        }

        .scenario-card p {
            white-space: pre-line !important;
            margin-bottom: 1rem !important;
        }
    </style>
</head>
<body>
    <!-- Connection status indicator -->
    <div id="connection-status" class="connection-status loading">
        🔄 Kobler til database...
    </div>

    <header class="header">
        <div class="container">
            <nav class="nav">
                <div class="logo">🏆 Suppa Business League</div>
                <div class="nav-links">
                    <a class="nav-link active" data-section="dashboard">Dashboard</a>
                    <a class="nav-link" data-section="scenario">Scenario</a>
                    <a class="nav-link" data-section="help">Hjelp</a>
                </div>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <!-- Dashboard Section -->
            <section id="dashboard" class="section">
                <div class="dashboard">
                    <h1>Velkommen til Suppa Business League! 🚀</h1>
                    <p><strong>Uke <span id="current-week">1</span> av 3</strong> - <span id="current-phase">Oppstart etter investorrunde</span></p>
                    
                    <div id="notifications" class="notifications"></div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="total-players">4</div>
                            <div class="stat-label">Deltakere</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="current-leader">Ingen leder</div>
                            <div class="stat-label">Nåværende Leder</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avg-value">500,000</div>
                            <div class="stat-label">Gjennomsnitt (NOK)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="scenario-status">Venter</div>
                            <div class="stat-label">Scenario Status</div>
                        </div>
                    </div>
                </div>

                <div class="leaderboard" id="leaderboard-container">
                    <h2>🏆 Leaderboard</h2>
                    <div id="leaderboard-content">
                        <p>Leaderboard lastes...</p>
                    </div>
                </div>
            </section>

            <!-- Scenario Section -->
            <section id="scenario" class="section hidden">
                <div class="scenario-section">
                    <div id="scenario-content">
                        <div class="scenario-card">
                            <h2>Ingen aktivt scenario</h2>
                            <p>Neste scenario kommer snart! Hold deg oppdatert på Dashboard.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Help Section -->
            <section id="help" class="section hidden">
                <div class="dashboard">
                    <h2>🎮 Hvordan spille</h2>
                    
                    <h3>📋 Regler</h3>
                    <p><strong>Mål:</strong> Få høyest Business Value etter 3 uker</p>
                    <p><strong>Start:</strong> 500,000 NOK på bankkonto</p>
                    <p><strong>Strategi:</strong> Velg smarte risiko/reward scenarioer</p>
                    
                    <h3>🎲 Scenarioer</h3>
                    <p>Hver uke presenteres et valgfritt scenario med 3-4 strategiske alternativer.</p>
                    <p>Du kan velge å delta - eller ikke! Høyere risiko kan gi større gevinst, men også større tap.</p>
                    <p>Hell eller uhell og business-logikk avgjør om strategien din lykkes eller feiler.</p>
                    
                    <h3>⚠️ Straffer</h3>
                    <p>Feil i Tripletex reduserer Business Value. Nøyaktighet lønner seg!</p>
                    
                    <h3>🏆 Vinnere</h3>
                    <p>Høyest Business Value etter 3 uker vinner!</p>
                    <p>Det teller både scenario-gevinster og regnskaps-nøyaktighet.</p>
                    
                    <h3>👁️ Transparency</h3>
                    <p><strong>Klikk på hvem som helst</strong> i leaderboard for å se deres detaljerte breakdown!</p>
                    <p>Alt er åpent og transparent - lær av hverandres strategier og resultater.</p>
                    
                    <h3>🤝 Support</h3>
                    <p><strong>Spørsmål eller problemer?</strong> Kontakt game master!</p>
                    <p>Rapporter bugs eller tekniske problemer umiddelbart.</p>
                </div>
            </section>
        </div>
    </main>

    <script>
        // GOOGLE SHEETS CONFIGURATION - UPDATED URL
        const GOOGLE_SHEETS_URL = 'https://script.google.com/macros/s/AKfycbykIkbZKKNW_FzCKmofoG2s3HVJqQvsfVRvDUfw2pYrH6bK0ekltOltxME0VFWXBrIyGA/exec';

        // Game state
        let gameState = {
            players: [],
            currentScenario: null,
            notifications: [],
            playerBreakdowns: {}
        };

        function updateConnectionStatus(status, message) {
            const statusEl = document.getElementById('connection-status');
            statusEl.className = `connection-status ${status}`;
            
            const icons = {
                loading: '🔄',
                connected: '✅',
                error: '❌'
            };
            
            statusEl.innerHTML = `${icons[status]} ${message}`;
            
            if (status === 'connected') {
                setTimeout(() => {
                    statusEl.style.opacity = '0.7';
                    statusEl.style.transform = 'scale(0.9)';
                }, 5000);
            }
        }

        // FIXED: Enhanced scenario loading with automatic breakdown sync
        function loadScenarioFromSheets() {
            console.log('🎲 Loading scenario from Google Sheets...');
            
            const callbackName = 'loadScenarioCallback_' + Date.now();
            const script = document.createElement('script');
            
            window[callbackName] = function(response) {
                document.head.removeChild(script);
                delete window[callbackName];
                
                console.log('🎲 Scenario response received:', response);
                
                if (response && response.status === 'success' && response.data) {
                    // Store scenario data
                    gameState.currentScenario = {
                        id: response.data.id,
                        title: response.data.title || 'Nytt Scenario',
                        background: response.data.background || '',
                        deadline: response.data.deadline || '',
                        tasks: response.data.tasks || [],
                        choices: response.data.choices || {},
                        results: response.data.results || {}
                    };
                    
                    console.log('✅ Scenario loaded successfully:', gameState.currentScenario.title);
                    console.log('🎯 Scenario has results:', Object.keys(gameState.currentScenario.results).length > 0);
                    
                    // CRITICAL: Sync results to breakdowns when scenario loads
                    syncScenarioResultsToBreakdowns();
                    
                    // Update UI
                    renderScenario();
                    renderLeaderboard(); // Re-render to show updated breakdowns
                    updateStats();
                    
                    // Check for results and notify
                    if (gameState.currentScenario.results && Object.keys(gameState.currentScenario.results).length > 0) {
                        addNotification(`🎊 Nye resultater tilgjengelig for: ${gameState.currentScenario.title}!`);
                        console.log('🎊 Results found in scenario:', gameState.currentScenario.results);
                    } else {
                        console.log('ℹ️ No results found in scenario yet');
                    }
                    
                } else if (response && response.status === 'success' && !response.data) {
                    console.log('ℹ️ No scenario found in Google Sheets - database empty');
                    gameState.currentScenario = null;
                    renderScenario();
                    updateStats();
                    addNotification(`ℹ️ Ingen aktive scenarioer i database`);
                } else {
                    console.log('❌ Invalid scenario response:', response);
                    addNotification(`❌ Feil ved lasting av scenario`);
                }
            };
            
            script.onerror = function() {
                document.head.removeChild(script);
                delete window[callbackName];
                console.log('❌ Failed to load scenario from Google Sheets');
                addNotification(`❌ Kunne ikke koble til scenario-database`);
            };
            
            script.src = GOOGLE_SHEETS_URL + '?callback=' + callbackName + '&action=getCurrentScenario';
            document.head.appendChild(script);
            
            setTimeout(() => {
                if (document.head.contains(script)) {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    console.log('⏰ Scenario loading timeout');
                }
            }, 15000);
        }

        // FIXED: Enhanced player loading with PROPER breakdown sync from scenario results
        function loadPlayersFromSheets() {
            console.log('📊 Loading players from Google Sheets...');
            updateConnectionStatus('loading', 'Laster spillere...');
            
            const callbackName = 'loadPlayersCallback_' + Date.now();
            const script = document.createElement('script');
            
            window[callbackName] = function(response) {
                document.head.removeChild(script);
                delete window[callbackName];
                
                console.log('📊 Players response:', response);
                
                if (response && response.status === 'success' && response.data && response.data.length > 0) {
                    gameState.players = response.data.map((player, index) => ({
                        name: player.name || `Spiller ${index + 1}`,
                        company: player.company || player.name || `Selskap ${index + 1}`,
                        businessValue: parseInt(player.businessValue) || 500000,
                        rank: parseInt(player.rank) || (index + 1)
                    }));
                    
                    // Sort by business value and update ranks
                    gameState.players.sort((a, b) => b.businessValue - a.businessValue);
                    gameState.players.forEach((player, index) => {
                        player.rank = index + 1;
                    });
                    
                    console.log('✅ Players loaded from database:', gameState.players.length, 'players');
                    
                    // CRITICAL: Sync scenario results into player breakdowns
                    syncScenarioResultsToBreakdowns();
                    
                    // Update UI
                    renderLeaderboard();
                    updateStats();
                    updateConnectionStatus('connected', 'Tilkoblet databasen');
                    
                    addNotification(`📊 ${gameState.players.length} spillere lastet fra database!`);
                    
                    // Load player breakdowns after loading players
                    setTimeout(loadPlayerBreakdownsFromSheets, 1000);
                    
                } else {
                    console.log('ℹ️ No players found in Google Sheets - database is empty');
                    updateConnectionStatus('connected', 'Database tom');
                    addNotification(`ℹ️ Database er tom. Venter på spillerdata fra admin.`);
                }
            };
            
            script.onerror = function() {
                document.head.removeChild(script);
                delete window[callbackName];
                updateConnectionStatus('error', 'Feil ved lasting av spillere');
                console.log('❌ Failed to load players from Google Sheets');
                addNotification(`❌ Kunne ikke laste spillerdata fra database.`);
            };
            
            script.src = GOOGLE_SHEETS_URL + '?callback=' + callbackName + '&action=getPlayers';
            document.head.appendChild(script);
            
            setTimeout(() => {
                if (document.head.contains(script)) {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    updateConnectionStatus('error', 'Timeout ved lasting');
                    console.log('⏰ Players loading timeout');
                }
            }, 15000);
        }

        // NEW: Sync scenario results into player breakdowns
        function syncScenarioResultsToBreakdowns() {
            if (!gameState.currentScenario || !gameState.currentScenario.results) {
                console.log('ℹ️ No scenario results to sync');
                return;
            }
            
            console.log('🔄 Syncing scenario results to player breakdowns...');
            
            Object.entries(gameState.currentScenario.results).forEach(([playerName, result]) => {
                if (!gameState.playerBreakdowns[playerName]) {
                    gameState.playerBreakdowns[playerName] = {
                        startCapital: 500000,
                        scenarioGains: [],
                        penalties: [],
                        bonuses: []
                    };
                }
                
                // Check if this result already exists
                const existingGain = gameState.playerBreakdowns[playerName].scenarioGains.find(
                    gain => gain.scenario === gameState.currentScenario.title && gain.choice === result.choice
                );
                
                if (!existingGain) {
                    gameState.playerBreakdowns[playerName].scenarioGains.push({
                        week: 'Current',
                        scenario: gameState.currentScenario.title,
                        choice: result.choice,
                        choiceTitle: result.choiceTitle,
                        outcome: result.outcome,
                        description: result.description,
                        value: result.valueChange
                    });
                    
                    console.log(`✅ Added scenario result for ${playerName}: ${result.valueChange} NOK`);
                }
            });
        }

        // FIXED: Player breakdowns loading with merge logic instead of overwrite
        function loadPlayerBreakdownsFromSheets() {
            console.log('💼 Loading player breakdowns from Google Sheets...');
            
            const callbackName = 'loadBreakdownsCallback_' + Date.now();
            const script = document.createElement('script');
            
            window[callbackName] = function(response) {
                document.head.removeChild(script);
                delete window[callbackName];
                
                if (response && response.status === 'success') {
                    const sheetsBreakdowns = response.data || {};
                    console.log('✅ Player breakdowns loaded from sheets:', Object.keys(sheetsBreakdowns).length, 'players');
                    
                    // CRITICAL: MERGE instead of replace to preserve scenario results
                    Object.entries(sheetsBreakdowns).forEach(([playerName, sheetsData]) => {
                        if (!gameState.playerBreakdowns[playerName]) {
                            // Player doesn't exist locally, use sheets data
                            gameState.playerBreakdowns[playerName] = sheetsData;
                        } else {
                            // Player exists locally, merge carefully
                            const localData = gameState.playerBreakdowns[playerName];
                            
                            // Merge penalties and bonuses from sheets (these are admin-controlled)
                            gameState.playerBreakdowns[playerName] = {
                                startCapital: sheetsData.startCapital || localData.startCapital || 500000,
                                scenarioGains: localData.scenarioGains || [], // KEEP LOCAL scenario results
                                penalties: sheetsData.penalties || [], // Use sheets penalties 
                                bonuses: sheetsData.bonuses || [] // Use sheets bonuses
                            };
                        }
                    });
                    
                    console.log('🔄 Merged breakdowns with local scenario results');
                    
                    // Force re-render leaderboard with merged data
                    renderLeaderboard();
                } else {
                    console.log('ℹ️ No player breakdowns found in Google Sheets - keeping local data');
                    gameState.playerBreakdowns = gameState.playerBreakdowns || {};
                }
            };
            
            script.onerror = function() {
                document.head.removeChild(script);
                delete window[callbackName];
                console.log('❌ Failed to load player breakdowns from Google Sheets - keeping local data');
                gameState.playerBreakdowns = gameState.playerBreakdowns || {};
            };
            
            script.src = GOOGLE_SHEETS_URL + '?callback=' + callbackName + '&action=getPlayerBreakdowns';
            document.head.appendChild(script);
        }

        // Navigation functionality
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                e.target.classList.add('active');
                
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.add('hidden');
                });
                
                const targetSection = e.target.getAttribute('data-section');
                document.getElementById(targetSection).classList.remove('hidden');
            });
        });

        // FIXED: Enhanced leaderboard rendering with better breakdown display
        function renderLeaderboard() {
            const container = document.getElementById('leaderboard-content');
            
            if (!gameState.players || gameState.players.length === 0) {
                container.innerHTML = '<p>Ingen spillere registrert ennå.</p>';
                return;
            }

            let html = '';
            gameState.players.forEach((player, index) => {
                const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
                
                // Check for penalties and recent gains
                const playerBreakdown = gameState.playerBreakdowns[player.name];
                let statusInfo = '';
                
                if (playerBreakdown) {
                    const penalties = playerBreakdown.penalties || [];
                    const gains = playerBreakdown.scenarioGains || [];
                    
                    if (penalties.length > 0) {
                        const totalPenalties = penalties.reduce((sum, penalty) => sum + Number(penalty.value), 0);
                        statusInfo += `
                            <div style="font-size: 0.8rem; color: #dc3545; margin-top: 0.3rem;">
                                <strong>Straffer:</strong> ${penalties.length} aktive (${totalPenalties.toLocaleString()} NOK)
                            </div>
                        `;
                    }
                    
                    if (gains.length > 0) {
                        const latestGain = gains[gains.length - 1];
                        if (latestGain) {
                            const gainColor = latestGain.value > 0 ? '#28a745' : '#dc3545';
                            statusInfo += `
                                <div style="font-size: 0.8rem; color: ${gainColor}; margin-top: 0.3rem;">
                                    <strong>Siste scenario:</strong> ${latestGain.value > 0 ? '+' : ''}${latestGain.value.toLocaleString()} NOK
                                </div>
                            `;
                        }
                    }
                }
                
                html += `
                    <div class="leaderboard-item" 
                         onclick="showPlayerBreakdown('${player.name}')" 
                         title="Klikk for å se ${player.name}'s detaljer"
                         data-player="${player.name}">
                        <span class="rank ${rankClass}">${player.rank}</span>
                        <div class="player-info">
                            <div class="player-name">${player.name}</div>
                            <div class="player-company">${player.company}</div>
                            ${statusInfo}
                        </div>
                        <span class="business-value">${player.businessValue.toLocaleString()} NOK</span>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function showPlayerBreakdown(playerName) {
            // Close any existing breakdown
            const existingBreakdown = document.querySelector('.breakdown.visible');
            if (existingBreakdown) {
                existingBreakdown.classList.remove('visible');
                existingBreakdown.remove();
            }
            
            const playerItem = document.querySelector(`[data-player="${playerName}"]`);
            if (!playerItem) return;
            
            const breakdownData = gameState.playerBreakdowns[playerName];
            if (!breakdownData) {
                const defaultBreakdown = {
                    startCapital: 500000,
                    scenarioGains: [],
                    penalties: [],
                    bonuses: []
                };
                const breakdownHTML = createBreakdownHTML(playerName, defaultBreakdown);
                playerItem.insertAdjacentHTML('afterend', breakdownHTML);
                return;
            }
            
            const breakdownHTML = createBreakdownHTML(playerName, breakdownData);
            playerItem.insertAdjacentHTML('afterend', breakdownHTML);
        }

        function createBreakdownHTML(playerName, breakdownData) {
            const totalScenarioGains = breakdownData.scenarioGains.reduce((sum, gain) => sum + Number(gain.value), 0);
            const totalPenalties = breakdownData.penalties.reduce((sum, penalty) => sum + Number(penalty.value), 0);
            const totalBonuses = breakdownData.bonuses.reduce((sum, bonus) => sum + Number(bonus.value), 0);
            const calculatedTotal = Number(breakdownData.startCapital) + totalScenarioGains + totalPenalties + totalBonuses;
            
            return `
                <div class="breakdown visible" id="breakdown-${playerName.replace(/\s+/g, '-')}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0; color: #3B82F6;">${playerName}'s Breakdown</h4>
                        <button class="btn" onclick="closeBreakdown(this)" style="width: auto; padding: 0.25rem 0.75rem; font-size: 0.8rem; margin: 0;">✕</button>
                    </div>
                    
                    <div class="breakdown-section">
                        <div class="breakdown-title">💰 Start Kapital</div>
                        <div class="breakdown-item neutral">
                            <span>Åpningsbalanse</span>
                            <span>${Number(breakdownData.startCapital).toLocaleString()} NOK</span>
                        </div>
                    </div>
                    
                    ${breakdownData.scenarioGains.length > 0 ? `
                    <div class="breakdown-section">
                        <div class="breakdown-title">🎲 Scenario Resultater</div>
                        ${breakdownData.scenarioGains.map(gain => {
                            const value = Number(gain.value);
                            const colorClass = value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
                            const sign = value > 0 ? '+' : '';
                            
                            return `
                                <div class="breakdown-item ${colorClass}">
                                    <span>${gain.scenario} - Valg ${gain.choice}) ${gain.choiceTitle || ''}</span>
                                    <span>${sign}${value.toLocaleString()} NOK</span>
                                </div>
                                <div style="font-size: 0.8rem; color: #666; margin-left: 1rem; margin-bottom: 0.5rem;">
                                    <strong>${gain.outcome}</strong>${gain.description ? ` - ${gain.description}` : ''}
                                </div>
                            `;
                        }).join('')}
                        <div class="breakdown-item ${totalScenarioGains > 0 ? 'positive' : totalScenarioGains < 0 ? 'negative' : 'neutral'}" style="font-weight: bold; border-top: 2px solid ${totalScenarioGains > 0 ? '#28a745' : totalScenarioGains < 0 ? '#dc3545' : '#6c757d'}; padding-top: 0.5rem;">
                            <span>Total scenario gevinster</span>
                            <span>${totalScenarioGains > 0 ? '+' : ''}${totalScenarioGains.toLocaleString()} NOK</span>
                        </div>
                    </div>
                    ` : `
                    <div class="breakdown-section">
                        <div class="breakdown-title">🎲 Scenario Resultater</div>
                        <div class="breakdown-item neutral">
                            <span>Ingen scenario gevinster ennå</span>
                            <span>0 NOK</span>
                        </div>
                    </div>
                    `}
                    
                    ${breakdownData.penalties.length > 0 ? `
                    <div class="breakdown-section">
                        <div class="breakdown-title">⚠️ Straffer</div>
                        ${breakdownData.penalties.map(penalty => {
                            const value = Number(penalty.value);
                            const colorClass = value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
                            const sign = value > 0 ? '+' : '';
                            
                            return `
                                <div class="breakdown-item ${colorClass}">
                                    <span>${penalty.type} (${penalty.status}) - ${penalty.date}</span>
                                    <span>${sign}${value.toLocaleString()} NOK</span>
                                </div>
                                <div style="font-size: 0.8rem; color: #666; margin-left: 1rem; margin-bottom: 0.5rem;">
                                    ${penalty.reason}
                                </div>
                            `;
                        }).join('')}
                        <div class="breakdown-item ${totalPenalties > 0 ? 'positive' : totalPenalties < 0 ? 'negative' : 'neutral'}" style="font-weight: bold; border-top: 2px solid ${totalPenalties > 0 ? '#28a745' : totalPenalties < 0 ? '#dc3545' : '#6c757d'}; padding-top: 0.5rem;">
                            <span>Total straffer</span>
                            <span>${totalPenalties > 0 ? '+' : ''}${totalPenalties.toLocaleString()} NOK</span>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${breakdownData.bonuses.length > 0 ? `
                    <div class="breakdown-section">
                        <div class="breakdown-title">🎉 Bonuser</div>
                        ${breakdownData.bonuses.map(bonus => {
                            const value = Number(bonus.value);
                            const colorClass = value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
                            const sign = value > 0 ? '+' : '';
                            
                            return `
                                <div class="breakdown-item ${colorClass}">
                                    <span>${bonus.type} - ${bonus.date}</span>
                                    <span>${sign}${value.toLocaleString()} NOK</span>
                                </div>
                                <div style="font-size: 0.8rem; color: #666; margin-left: 1rem; margin-bottom: 0.5rem;">
                                    ${bonus.reason}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    ` : ''}
                    
                    <div class="breakdown-total">
                        📊 Total Business Value: ${calculatedTotal.toLocaleString()} NOK
                    </div>
                </div>
            `;
        }

        function closeBreakdown(button) {
            const breakdown = button.closest('.breakdown');
            if (breakdown) {
                breakdown.classList.remove('visible');
                breakdown.remove();
            }
        }

        // FIXED: Enhanced scenario rendering with PROPER results display and DOM verification
        function renderScenario() {
            const container = document.getElementById('scenario-content');
            
            if (!container) {
                console.error('❌ scenario-content element not found in DOM!');
                return;
            }
            
            console.log('🎯 renderScenario called, container found:', container);
            
            if (!gameState.currentScenario) {
                console.log('ℹ️ No current scenario, showing default message');
                container.innerHTML = `
                    <div class="scenario-card">
                        <h2>Ingen aktivt scenario</h2>
                        <p>Neste scenario kommer snart! Hold deg oppdateret på Dashboard.</p>
                        <p><em>Scenarioer styres av admin og oppdateres her når de er aktive.</em></p>
                    </div>
                `;
                return;
            }

            const scenario = gameState.currentScenario;
            const deadline = scenario.deadline ? new Date(scenario.deadline) : null;
            const now = new Date();
            const timeLeft = deadline ? deadline - now : 0;
            const isExpired = timeLeft <= 0;
            
            // FIXED: Check for results properly
            const hasResults = scenario.results && Object.keys(scenario.results).length > 0;
            console.log('🎯 Checking scenario results:', hasResults, scenario.results);
            
            let deadlineHtml = '';
            if (deadline && !isExpired && !hasResults) {
                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                
                const urgentClass = timeLeft < 24 * 60 * 60 * 1000 ? 'urgent' : '';
                deadlineHtml = `
                    <div class="scenario-deadline ${urgentClass}">
                        ⏰ Deadline: ${days}d ${hours}t ${minutes}m igjen
                    </div>
                `;
            } else if (deadline && isExpired && !hasResults) {
                deadlineHtml = `
                    <div class="scenario-deadline urgent">
                        ⏰ Deadline passert - venter på resultater
                    </div>
                `;
            }

            // Build tasks HTML
            let tasksHtml = '';
            if (scenario.tasks && scenario.tasks.length > 0) {
                tasksHtml = '<div class="scenario-tasks"><h3>📋 Obligatoriske Oppgaver:</h3>';
                
                scenario.tasks.forEach(task => {
                    let taskContent = '';
                    
                    if (task.type === 'table' && task.tableData && task.tableData.length > 0) {
                        taskContent = `
                            <div class="task-title">${task.title}</div>
                            <table class="accounting-table">
                                <thead>
                                    <tr>
                                        <th>Konto</th>
                                        <th>Beskrivelse</th>
                                        <th class="amount">Beløp</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        task.tableData.forEach(row => {
                            taskContent += `
                                <tr>
                                    <td><strong>${row.account}</strong></td>
                                    <td>${row.description}</td>
                                    <td class="amount">${row.amount}</td>
                                </tr>
                            `;
                        });
                        
                        taskContent += `
                                </tbody>
                            </table>
                        `;
                    } else {
                        taskContent = `
                            <div class="task-title">${task.title}</div>
                            <div class="task-description">${task.description || ''}</div>
                        `;
                    }
                    
                    tasksHtml += `
                        <div class="task-display">
                            <div class="task-number">${task.number}</div>
                            <div class="task-content">
                                ${taskContent}
                                <div class="task-rewards">
                                    ${task.reward ? `<div class="task-reward">✅ ${task.reward}</div>` : ''}
                                    ${task.penalty ? `<div class="task-penalty">❌ ${task.penalty}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                tasksHtml += '</div>';
            }

            // Build choices HTML if no results yet
            let choicesHtml = '';
           if (scenario.choices && Object.keys(scenario.choices).length > 0 && !hasResults && !isExpired) {
                choicesHtml = '<div class="scenario-choices"><h3>📋 Valgalternativer:</h3>';
                
                Object.entries(scenario.choices).forEach(([key, choice]) => {
                    if (typeof choice === 'string') {
                        choicesHtml += `
                            <div class="choice-display">
                                <div class="choice-letter">${key})</div>
                                <div class="choice-content">
                                    <div class="choice-title">${choice}</div>
                                </div>
                            </div>
                        `;
                    } else {
                        choicesHtml += `
                            <div class="choice-display">
                                <div class="choice-letter">${key})</div>
                                <div class="choice-content">
                                    <div class="choice-title">${choice.title || choice}</div>
                                    ${choice.cost ? `<div class="choice-cost">💰 ${choice.cost}</div>` : ''}
                                    ${choice.potential ? `<div class="choice-potential">🎯 ${choice.potential}</div>` : ''}
                                    ${choice.odds ? `<div class="choice-odds">🎲 ${choice.odds}</div>` : ''}
                                </div>
                            </div>
                        `;
                    }
                });
                choicesHtml += '</div>';
                
if (!isExpired) {
    choicesHtml += `
        <div class="scenario-note">
            <p><strong>⏰ VIKTIG:</strong> Du kan velge ett alternativ før deadline</p>
            <p><strong>👆</strong> Klikk på ønsket valg for å registrere</p>
            <p><strong>⚖️</strong> Vurder risiko vs. belønning nøye - du kan både vinne og tape penger</p>
            <p><strong>💭</strong> Husk: Å velge å ikke investere sitt kapital er også et strategisk valg</p>
        </div>
    `;
} else {
                    choicesHtml += `
                        <div class="scenario-note">
                            <p><strong>⏰ Valg-periode avsluttet</strong></p>
                            <p>Venter på business-resultater...</p>
                        </div>
                    `;
                }
            }

            // FIXED: Build results HTML with enhanced styling and DEBUG logging
            let resultsHtml = '';
            if (hasResults) {
                console.log('🎊 Rendering results for scenario:', scenario.title);
                console.log('🎊 Results data:', scenario.results);
                console.log('🎊 Number of results:', Object.keys(scenario.results).length);
                
                resultsHtml = `
                    <div class="scenario-results">
                        <h3>🎊 Scenario Resultater!</h3>
                        <div class="results-grid">
                `;
                
                Object.entries(scenario.results).forEach(([playerName, result]) => {
                    console.log(`🎊 Processing result for ${playerName}:`, result);
                    
                    const isPositive = result.valueChange >= 0;
                    const outcomeClass = result.outcome.toLowerCase().includes('fiasko') ? 'failure' : 
                                       result.outcome.toLowerCase().includes('moderat') ? 'moderate' : 'success';
                    
                    resultsHtml += `
                        <div class="result-item">
                            <div class="result-player">${playerName}</div>
                            <div class="result-choice"><strong>Valg:</strong> ${result.choice}) ${result.choiceTitle || result.choice}</div>
                            <div class="result-outcome ${outcomeClass}">${result.outcome}</div>
                            ${result.description ? `<div style="font-size: 0.9rem; color: #666; margin: 0.5rem 0; font-style: italic;">${result.description}</div>` : ''}
                            <div class="result-value ${isPositive ? 'positive' : 'negative'}">
                                ${isPositive ? '+' : ''}${result.valueChange.toLocaleString()} NOK
                            </div>
                        </div>
                    `;
                });
                
                resultsHtml += `
                        </div>
                        <div class="scenario-note">
                            <p><strong>💼 Neste steg:</strong> Implementer effektene i ditt Tripletex-regnskap!</p>
                            <p><strong>📊</strong> Leaderboard på Dashboard viser oppdaterte verdier.</p>
                        </div>
                    </div>
                `;
                
                console.log('🎊 Generated results HTML length:', resultsHtml.length);
            } else {
                console.log('ℹ️ No results to render');
            }

            // FIXED: Combine all HTML parts with DOM verification
            const finalHTML = `
                <div class="scenario-card">
                    <h2>${scenario.title}</h2>
                    ${scenario.background ? `<p>${scenario.background}</p>` : 
                      scenario.description ? `<p>${scenario.description}</p>` : ''}
                    ${deadlineHtml}
                    ${tasksHtml}
                    ${choicesHtml}
                    ${resultsHtml}
                </div>
            `;
            
            console.log('🎯 Final HTML length:', finalHTML.length);
            console.log('🎯 HTML contains results:', finalHTML.includes('scenario-results'));
            console.log('🎯 Setting innerHTML on container:', container);
            
            // Set the HTML
            container.innerHTML = finalHTML;
            
            // VERIFY the update worked
            setTimeout(() => {
                const updatedContainer = document.getElementById('scenario-content');
                const resultsSection = updatedContainer ? updatedContainer.querySelector('.scenario-results') : null;
                
                console.log('🔍 DOM Verification after innerHTML:');
                console.log('  - Container exists:', !!updatedContainer);
                console.log('  - Container innerHTML length:', updatedContainer ? updatedContainer.innerHTML.length : 0);
                console.log('  - Results section found:', !!resultsSection);
                
                if (hasResults && !resultsSection) {
                    console.error('❌ CRITICAL: Results HTML was generated but not found in DOM!');
                    console.error('❌ This suggests a DOM rendering issue');
                    
                    // FORCE a direct results injection as fallback
                    if (updatedContainer) {
                        console.log('🔧 ATTEMPTING FORCE INJECTION...');
                        const forceResultsDiv = document.createElement('div');
                        forceResultsDiv.innerHTML = resultsHtml;
                        updatedContainer.appendChild(forceResultsDiv);
                        console.log('🔧 Force injection completed');
                    }
                } else if (hasResults && resultsSection) {
                    console.log('✅ Results successfully rendered in DOM!');
                }
            }, 100);
            
            // Make choices clickable after rendering (only if no results)
            if (!hasResults) {
                setTimeout(() => {
                    makeChoicesClickable();
                }, 200);
            }
        }

        // Choice clicking functionality
        function makeChoicesClickable() {
            const choiceElements = document.querySelectorAll('.choice-display');
            
            choiceElements.forEach((choiceEl) => {
                if (choiceEl.hasAttribute('data-clickable')) return;
                choiceEl.setAttribute('data-clickable', 'true');
                
                let choiceLetter = '';
                const choiceLetterEl = choiceEl.querySelector('.choice-letter');
                if (choiceLetterEl) {
                    choiceLetter = choiceLetterEl.textContent.replace(')', '');
                } else {
                    const choiceTitle = choiceEl.querySelector('.choice-title').textContent;
                    const letterMatch = choiceTitle.match(/^([A-Z])\)/);
                    choiceLetter = letterMatch ? letterMatch[1] : 'A';
                }
                
                choiceEl.style.cursor = 'pointer';
                choiceEl.style.transition = 'all 0.3s ease';
                
                choiceEl.addEventListener('mouseenter', () => {
                    choiceEl.style.transform = 'translateX(5px)';
                    choiceEl.style.boxShadow = '0 4px 15px rgba(0,0,0,0.1)';
                });
                
                choiceEl.addEventListener('mouseleave', () => {
                    choiceEl.style.transform = 'translateX(0)';
                    choiceEl.style.boxShadow = 'none';
                });
                
                choiceEl.addEventListener('click', async () => {
                    const playerName = prompt('Skriv inn ditt navn for å velge dette alternativet:');
                    if (playerName && playerName.trim()) {
                        const choiceTitle = choiceEl.querySelector('.choice-title').textContent;
                        const confirmed = confirm(`${playerName}, bekrefter du valg ${choiceLetter}: ${choiceTitle}?`);
                        
                        if (confirmed) {
                            await sendChoiceToSheets(choiceEl, choiceLetter, choiceTitle, playerName.trim());
                        }
                    }
                });
                
                const choiceContent = choiceEl.querySelector('.choice-content');
                if (choiceContent && !choiceContent.querySelector('.click-hint')) {
                    const clickHint = document.createElement('div');
                    clickHint.innerHTML = '👆 Klikk for å velge';
                    clickHint.className = 'click-hint';
                    clickHint.style.cssText = 'font-size: 0.8rem; color: #3B82F6; margin-top: 0.5rem; opacity: 0.7;';
                    choiceContent.appendChild(clickHint);
                }
            });
        }

        // Send choice to Google Sheets
        async function sendChoiceToSheets(choiceEl, choiceLetter, choiceTitle, playerName) {
            const originalBg = choiceEl.style.backgroundColor;
            choiceEl.style.backgroundColor = '#fff3cd';
            choiceEl.style.borderColor = '#ffc107';
            
            const loadingEl = document.createElement('div');
            loadingEl.innerHTML = '⏳ Sender valg...';
            loadingEl.style.cssText = 'font-size: 0.8rem; color: #856404; margin-top: 0.5rem; font-weight: bold;';
            choiceEl.appendChild(loadingEl);
            
            const choiceData = {
                player: playerName,
                choice: choiceLetter,
                choiceTitle: choiceTitle,
                scenarioTitle: gameState.currentScenario ? gameState.currentScenario.title : 'Unknown Scenario',
                week: 'Current',
                timestamp: new Date().toISOString()
            };
            
            try {
                await new Promise((resolve, reject) => {
                    const callbackName = 'choiceCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                    const script = document.createElement('script');
                    
                    window[callbackName] = function(response) {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        
                        if (response && response.status === 'success') {
                            resolve(true);
                        } else {
                            reject(new Error(response ? response.message : 'Unknown error'));
                        }
                    };
                    
                    script.onerror = function() {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        reject(new Error('Failed to load script'));
                    };

                    script.crossOrigin = 'anonymous';
                    
                    const params = new URLSearchParams({
                        callback: callbackName,
                        player: choiceData.player,
                        choice: choiceData.choice,
                        choiceTitle: choiceData.choiceTitle,
                        scenarioTitle: choiceData.scenarioTitle,
                        week: choiceData.week,
                        timestamp: choiceData.timestamp
                    });
                    
                    script.src = GOOGLE_SHEETS_URL + '?' + params.toString();
                    document.head.appendChild(script);
                    
                    setTimeout(() => {
                        if (document.head.contains(script)) {
                            document.head.removeChild(script);
                            delete window[callbackName];
                            reject(new Error('Request timeout'));
                        }
                    }, 10000);
                });
                
                // Success
                choiceEl.removeChild(loadingEl);
                choiceEl.style.backgroundColor = '#d4edda';
                choiceEl.style.borderColor = '#28a745';
                
                alert(`✅ Valg registrert: ${choiceLetter}) ${choiceTitle}\n\nDitt valg er sendt til admin og lagret i systemet!`);
                
                const successEl = document.createElement('div');
                successEl.innerHTML = '✅ Valg registrert!';
                successEl.style.cssText = 'font-size: 0.8rem; color: #155724; margin-top: 0.5rem; font-weight: bold;';
                choiceEl.appendChild(successEl);
                
                choiceEl.style.pointerEvents = 'none';
                choiceEl.style.opacity = '0.8';
                
                addNotification(`✅ ${playerName} valgte ${choiceLetter}: ${choiceTitle}`);
                
            } catch (error) {
                console.error('Error sending choice:', error);
                
                if (choiceEl.contains(loadingEl)) {
                    choiceEl.removeChild(loadingEl);
                }
                
                choiceEl.style.backgroundColor = '#f8d7da';
                choiceEl.style.borderColor = '#dc3545';
                
                alert('❌ Feil ved sending av valg: ' + error.message + '\n\nPrøv igjen eller kontakt admin.');
                
                setTimeout(() => {
                    choiceEl.style.backgroundColor = originalBg;
                    choiceEl.style.borderColor = '';
                }, 3000);
            }
        }

        function updateStats() {
            // Update dashboard stats
            document.getElementById('total-players').textContent = gameState.players.length;
            
            if (gameState.players.length > 0) {
                const leader = gameState.players[0];
                document.getElementById('current-leader').textContent = leader.name.split(' ')[0];
                
                const avgValue = gameState.players.reduce((sum, p) => sum + p.businessValue, 0) / gameState.players.length;
                document.getElementById('avg-value').textContent = avgValue.toLocaleString();
            }

            // Update scenario status
            const scenarioStatusEl = document.getElementById('scenario-status');
            if (gameState.currentScenario) {
                const hasResults = gameState.currentScenario.results && Object.keys(gameState.currentScenario.results).length > 0;
                
                if (hasResults) {
                    scenarioStatusEl.textContent = 'Resultater klar';
                } else {
                    const deadline = gameState.currentScenario.deadline ? new Date(gameState.currentScenario.deadline) : null;
                    const now = new Date();
                    
                    if (deadline && deadline < now) {
                        scenarioStatusEl.textContent = 'Utløpt';
                    } else if (deadline) {
                        scenarioStatusEl.textContent = 'Aktiv';
                    } else {
                        scenarioStatusEl.textContent = 'Oppgaver tilgjengelig';
                    }
                }
            } else {
                scenarioStatusEl.textContent = 'Ingen aktive';
            }
        }

        function addNotification(message, type = 'info') {
            gameState.notifications.unshift({
                message,
                type,
                timestamp: new Date(),
                id: Date.now()
            });
            renderNotifications();
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                gameState.notifications = gameState.notifications.filter(n => n.id !== gameState.notifications[0].id);
                renderNotifications();
            }, 10000);
        }

        function renderNotifications() {
            const container = document.getElementById('notifications');
            
            if (gameState.notifications.length === 0) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            gameState.notifications.slice(0, 3).forEach(notification => {
                html += `
                    <div class="notification">
                        📢 ${notification.message}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Admin panel can call this function to update the platform
        window.updateGameData = function(newData) {
            if (newData.players) {
                gameState.players = newData.players;
                renderLeaderboard();
                updateStats();
            }
            if (newData.playerBreakdowns) {
                gameState.playerBreakdowns = newData.playerBreakdowns;
                renderLeaderboard(); // Re-render to show penalty info
            }
            if (newData.scenario) {
                gameState.currentScenario = newData.scenario;
                renderScenario();
                updateStats();
            }
            if (newData.notification) {
                addNotification(newData.notification.message, newData.notification.type);
            }
        };

        // FIXED: Enhanced auto-refresh with better result detection
        function startAutoRefresh() {
            setInterval(() => {
                if (gameState.currentScenario && gameState.currentScenario.deadline) {
                    renderScenario(); // Updates countdown
                    updateStats(); // Updates scenario status
                }
                
                // Auto-refresh scenario data every 2 minutes to check for new results
                console.log('🔄 Auto-refreshing scenario data...');
                loadScenarioFromSheets();
                
                // Also refresh player data to catch any admin updates
                loadPlayersFromSheets();
                
            }, 120000); // Every 2 minutes
        }

        // Test Google Sheets connection
        function testGoogleSheetsConnection() {
            console.log('🔗 Testing Google Sheets connection...');
            updateConnectionStatus('loading', 'Tester forbindelse...');
            
            const callbackName = 'testCallback_' + Date.now();
            const script = document.createElement('script');
            
            window[callbackName] = function(response) {
                document.head.removeChild(script);
                delete window[callbackName];
                
                console.log('📡 Google Sheets response:', response);
                
                if (response && response.status === 'success') {
                    updateConnectionStatus('connected', 'Tilkoblet databasen');
                    console.log('✅ Google Sheets connection successful');
                } else {
                    updateConnectionStatus('error', 'Forbindelsesfeil');
                    console.log('❌ Google Sheets connection failed:', response);
                }
            };
            
            script.onerror = function() {
                document.head.removeChild(script);
                delete window[callbackName];
                updateConnectionStatus('error', 'Kan ikke nå databasen');
                console.log('❌ Google Sheets network error');
            };
            
            script.src = GOOGLE_SHEETS_URL + '?callback=' + callbackName + '&action=getPlayers';
            document.head.appendChild(script);
            
            setTimeout(() => {
                if (document.head.contains(script)) {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    updateConnectionStatus('error', 'Forbindelse timeout');
                    console.log('❌ Google Sheets connection timeout');
                }
            }, 15000);
        }

        // DEBUG FUNCTIONS - Enhanced with DOM verification
        window.debugScenarioResults = function() {
            console.log('🔧 DEBUG: Current scenario state');
            console.log('  Scenario exists:', !!gameState.currentScenario);
            if (gameState.currentScenario) {
                console.log('  Title:', gameState.currentScenario.title);
                console.log('  Has results:', !!gameState.currentScenario.results);
                console.log('  Results count:', gameState.currentScenario.results ? Object.keys(gameState.currentScenario.results).length : 0);
                console.log('  Results data:', gameState.currentScenario.results);
            }
            
            // Check DOM state
            console.log('🔧 DEBUG: DOM state');
            const container = document.getElementById('scenario-content');
            console.log('  Container exists:', !!container);
            if (container) {
                console.log('  Container innerHTML length:', container.innerHTML.length);
                const resultsSection = container.querySelector('.scenario-results');
                console.log('  Results section in DOM:', !!resultsSection);
                if (resultsSection) {
                    console.log('  Results section innerHTML length:', resultsSection.innerHTML.length);
                }
            }
        };

        window.forceLoadScenario = function() {
            console.log('🔧 DEBUG: Force loading scenario...');
            loadScenarioFromSheets();
        };

        window.forceRenderScenario = function() {
            console.log('🔧 DEBUG: Force rendering scenario...');
            renderScenario();
        };

        window.testResultsHTML = function() {
            console.log('🔧 DEBUG: Testing results HTML generation...');
            
            if (!gameState.currentScenario || !gameState.currentScenario.results) {
                console.log('❌ No scenario or results to test with');
                return;
            }
            
            const container = document.getElementById('scenario-content');
            if (!container) {
                console.log('❌ Container not found');
                return;
            }
            
            // Inject test results HTML directly
            const testHTML = `
                <div class="scenario-results" style="background: red; padding: 20px; color: white;">
                    <h3>🧪 TEST RESULTS SECTION</h3>
                    <div>This is a test to verify DOM injection works</div>
                </div>
            `;
            
            container.innerHTML = testHTML;
            console.log('🧪 Test HTML injected - check if red box appears');
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing Suppa Business League...');
            
            // Test connection first
            testGoogleSheetsConnection();
            
            // Load data from Google Sheets with proper timing
            setTimeout(() => {
                console.log('📊 Loading players from database...');
                loadPlayersFromSheets();
            }, 2000);
            
            setTimeout(() => {
                console.log('🎲 Loading scenario from database...');
                loadScenarioFromSheets();
            }, 4000);
            
            // Initial render
            renderLeaderboard();
            renderScenario();
            updateStats();
            
            // Start auto-refresh
            startAutoRefresh();
            
            // Welcome notification
            addNotification('Velkommen til Suppa Business League! Klikk på spillere for å se detaljer. 🎉');
            
            console.log('✅ Initialization complete');
        });

        // Expose debug functions to global scope
        window.gameState = gameState;
        window.loadScenarioFromSheets = loadScenarioFromSheets;
        window.loadPlayersFromSheets = loadPlayersFromSheets;
    </script>
</body>
</html>
