<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suppa Business League</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0066CC 0%, #00A651 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 0;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: #0066CC;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .nav-links a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s ease;
            cursor: pointer;
        }

        .nav-links a:hover, .nav-links a.active {
            color: #0066CC;
        }

        .main-content {
            padding: 2rem 0;
        }

        .dashboard {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(145deg, #f0f0f0, #ffffff);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #0066CC;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .leaderboard {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .leaderboard h2 {
            margin-bottom: 1.5rem;
            color: #333;
            text-align: center;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(145deg, #f9f9f9, #ffffff);
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .leaderboard-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .rank {
            font-weight: bold;
            font-size: 1.2rem;
            color: #0066CC;
            min-width: 40px;
        }

        .rank.gold { color: #FFD700; }
        .rank.silver { color: #C0C0C0; }
        .rank.bronze { color: #CD7F32; }

        .player-info {
            flex-grow: 1;
            margin-left: 1rem;
        }

        .player-name {
            font-weight: bold;
            margin-bottom: 0.2rem;
        }

        .player-company {
            color: #666;
            font-size: 0.9rem;
        }

        .business-value {
            font-weight: bold;
            color: #28a745;
            font-size: 1.1rem;
        }

        .breakdown {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-top: 0.5rem;
            padding: 1rem;
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        .breakdown.visible {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
                padding: 0 1rem;
            }
            to {
                opacity: 1;
                max-height: 500px;
                padding: 1rem;
            }
        }

        .breakdown-section {
            margin-bottom: 1rem;
            border-left: 3px solid #0066CC;
            padding-left: 1rem;
        }

        .breakdown-section:last-child {
            margin-bottom: 0;
        }

        .breakdown-title {
            font-weight: bold;
            color: #0066CC;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            border-bottom: 1px solid #e9ecef;
        }

        .breakdown-item:last-child {
            border-bottom: none;
        }

        .breakdown-item.positive {
            color: #28a745;
        }

        .breakdown-item.negative {
            color: #dc3545;
        }

        .breakdown-item.neutral {
            color: #6c757d;
        }

        .breakdown-total {
            background: #0066CC;
            color: white;
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            font-weight: bold;
            text-align: center;
        }

        .scenario-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .scenario-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .scenario-deadline {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: bold;
        }

        /* Performance Chart Styles */
        .chart-controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .player-toggles {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .player-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .player-toggle:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .player-checkbox {
            accent-color: #0066CC;
        }

        .player-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-left: auto;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            height: 500px;
        }

        .chart-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem;
        }

        .milestone-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .milestone-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .milestone-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .scenario-gain {
            background: #28a745;
        }

        .penalty {
            background: #dc3545;
        }

        .bonus {
            background: #ffc107;
        }

        /* Scenario styling (existing) */
        .scenario-tasks {
            margin: 1.5rem 0;
        }

        .task-display {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(145deg, #f8f9ff, #ffffff);
            border-radius: 12px;
            border-left: 4px solid #0066CC;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .task-display:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .task-number {
            font-weight: bold;
            font-size: 1.3rem;
            color: #0066CC;
            min-width: 35px;
            background: rgba(0, 102, 204, 0.1);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .task-content {
            flex-grow: 1;
        }

        .task-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .task-description {
            color: #666;
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }

        .task-rewards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .task-reward {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
            font-weight: bold;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.9rem;
            border: 1px solid rgba(40, 167, 69, 0.2);
        }

        .task-penalty {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            font-weight: bold;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.9rem;
            border: 1px solid rgba(220, 53, 69, 0.2);
        }

        .scenario-choices {
            margin: 1.5rem 0;
        }

        .choice-display {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background: linear-gradient(145deg, #f9f9f9, #ffffff);
            border-radius: 8px;
            border-left: 4px solid #0066CC;
        }

        .choice-letter {
            font-weight: bold;
            font-size: 1.2rem;
            color: #0066CC;
            min-width: 30px;
        }

        .choice-content {
            flex-grow: 1;
        }

        .choice-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .choice-cost {
            color: #dc3545;
            font-weight: bold;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .choice-potential {
            color: #28a745;
            font-weight: bold;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .choice-odds {
            color: #666;
            font-size: 0.85rem;
        }

        .scenario-note {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .scenario-note p {
            margin-bottom: 0.5rem;
        }

        .scenario-note p:last-child {
            margin-bottom: 0;
        }

        .scenario-results {
            margin-top: 2rem;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .result-item {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #0066CC;
        }

        .result-player {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #0066CC;
        }

        .result-choice, .result-dice, .result-outcome {
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
            color: #666;
        }

        .result-value {
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 0.5rem;
        }

        .result-value.positive {
            color: #28a745;
        }

        .result-value.negative {
            color: #dc3545;
        }

        .btn {
            background: linear-gradient(145deg, #0066CC, #00A651);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .notification {
            background: #cce7ff;
            border: 1px solid #99d6ff;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hidden {
            display: none;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 0.75rem 1rem;
            border-radius: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            font-size: 0.85rem;
            font-weight: 500;
            z-index: 1000;
            transition: all 0.3s ease;
            border: 2px solid #e0e0e0;
            min-width: 180px;
            text-align: center;
        }

        .connection-status.connected {
            color: #28a745;
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }

        .connection-status.loading {
            color: #ffc107;
            border-color: #ffc107;
            background: rgba(255, 193, 7, 0.1);
        }

        .connection-status.error {
            color: #dc3545;
            border-color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            .nav {
                flex-direction: column;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .task-display {
                flex-direction: column;
                gap: 0.75rem;
            }

            .task-number {
                align-self: flex-start;
            }

            .task-rewards {
                grid-template-columns: 1fr;
            }

            .connection-status {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 1rem;
            }
        }
    </style>
    <!-- Chart.js Date Adapter -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.29.3/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-adapter-date-fns/3.0.0/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.2.1/chart.min.js"></script>
</head>
<body>
    <!-- Connection status indicator -->
    <div id="connection-status" class="connection-status loading">
        üîÑ Kobler til Google Sheets...
    </div>

    <header class="header">
        <div class="container">
            <nav class="nav">
                <div class="logo">üèÜ Suppa Business League</div>
                <div class="nav-links">
                    <a class="nav-link active" data-section="dashboard">Dashboard</a>
                    <a class="nav-link" data-section="scenario">Scenario</a>
                    <a class="nav-link" data-section="performance">üìà Performance</a>
                    <a class="nav-link" data-section="help">Hjelp</a>
                </div>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <!-- Dashboard Section -->
            <section id="dashboard" class="section">
                <div class="dashboard">
                    <h1>Velkommen til Suppa Business League! üöÄ</h1>
                    <p><strong>Uke <span id="current-week">1</span> av 12</strong> - <span id="current-phase">Foundation Phase</span></p>
                    
                    <div id="notifications" class="notifications"></div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="total-players">4</div>
                            <div class="stat-label">Aktive Spillere</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="current-leader">Ingen leder</div>
                            <div class="stat-label">N√•v√¶rende Leder</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avg-value">500,000</div>
                            <div class="stat-label">Gjennomsnitt (NOK)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="scenario-status">Venter</div>
                            <div class="stat-label">Scenario Status</div>
                        </div>
                    </div>
                </div>

                <div class="leaderboard" id="leaderboard-container">
                    <h2>üèÜ Leaderboard</h2>
                    <div id="leaderboard-content">
                        <p>Leaderboard lastes...</p>
                    </div>
                </div>
            </section>

            <!-- Scenario Section -->
            <section id="scenario" class="section hidden">
                <div class="scenario-section">
                    <div id="scenario-content">
                        <div class="scenario-card">
                            <h2>Ingen aktivt scenario</h2>
                            <p>Neste scenario kommer snart! Hold deg oppdatert p√• Dashboard.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Performance Section -->
            <section id="performance" class="section hidden">
                <div class="dashboard">
                    <h2>üìà Performance Analytics</h2>
                    <p>Se hvordan spillerne utvikler seg over tid</p>
                    
                    <div class="chart-controls">
                        <h3 style="margin-bottom: 1rem;">Velg spillere √• sammenligne:</h3>
                        <div class="player-toggles" id="player-toggles">
                            <!-- Player toggles will be populated by JavaScript -->
                        </div>
                        
                        <div class="milestone-legend">
                            <div class="milestone-item">
                                <div class="milestone-dot scenario-gain"></div>
                                <span>Scenario Gevinst</span>
                            </div>
                            <div class="milestone-item">
                                <div class="milestone-dot penalty"></div>
                                <span>Straff</span>
                            </div>
                            <div class="milestone-item">
                                <div class="milestone-dot bonus"></div>
                                <span>Bonus/Korreksjon</span>
                            </div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>

                    <div class="chart-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="best-performer">-</div>
                            <div class="stat-label">Mest Forbedring</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="most-consistent">-</div>
                            <div class="stat-label">Mest Konsistent</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="biggest-swing">-</div>
                            <div class="stat-label">St√∏rste Svingning</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="total-events">-</div>
                            <div class="stat-label">Totale Hendelser</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Help Section -->
            <section id="help" class="section hidden">
                <div class="dashboard">
                    <h2>üéÆ Hvordan spille</h2>
                    
                    <h3>üìã Regler</h3>
                    <p><strong>M√•l:</strong> F√• h√∏yest Business Value etter 12 uker</p>
                    <p><strong>Start:</strong> 500,000 NOK p√• bankkonto</p>
                    <p><strong>Strategi:</strong> Velg smarte risiko/reward scenarioer</p>
                    
                    <h3>üé≤ Scenarioer</h3>
                    <p>Hver m√•ned f√•r du et scenario med 3-4 valg. H√∏yere risiko = h√∏yere potensial!</p>
                    <p>Business-logikk avgj√∏r utfall basert p√• strategiske beslutninger.</p>
                    
                    <h3>‚ö†Ô∏è Straffer</h3>
                    <p>Feil i Tripletex gir automatiske kostnader:</p>
                    <ul style="margin: 1rem 0; padding-left: 2rem;">
                        <li>Feil √•pningsbalanse: -50,000 NOK</li>
                        <li>Feil MVA-oppsett: -25,000 NOK/dag</li>
                        <li>Manglende f√∏rste salg: -10,000 NOK/dag</li>
                        <li>Feil kontokoder: -5,000 NOK per feil</li>
                    </ul>
                    
                    <h3>üèÜ Vinnere</h3>
                    <p>H√∏yest Business Value etter 12 uker vinner!</p>
                    <p>Det teller b√•de scenario-gevinster og regnskaps-n√∏yaktighet.</p>
                    
                    <h3>üëÅÔ∏è Transparency</h3>
                    <p><strong>Klikk p√• hvem som helst</strong> i leaderboard for √• se deres detaljerte breakdown!</p>
                    <p>Alt er √•pent og transparent - l√¶r av hverandres strategier og resultater.</p>
                </div>
            </section>
        </div>
    </main>

    <script>
        // GOOGLE SHEETS CONFIGURATION
        const GOOGLE_SHEETS_URL = 'https://script.google.com/a/macros/visma.com/s/AKfycbwWPU-f-cOxUrf0sgJeM7wWZ-VRkAdWbuGmJAvxc-uk32DRygAtwt6sz_Dj-VqpdJqi0Q/exec';

        // Game state
        let gameState = {
            players: [],
            currentScenario: null,
            notifications: [],
            playerBreakdowns: {}
        };

        // Performance Chart Variables
        let performanceChart = null;
        let visiblePerformancePlayers = new Set();

        // Color palette for performance chart
        const playerColors = [
            '#0066CC', '#00A651', '#FF6B35', '#8E44AD',
            '#E74C3C', '#F39C12', '#1ABC9C', '#34495E'
        ];

        // Connection status functions
        function updateConnectionStatus(status, message) {
            const statusEl = document.getElementById('connection-status');
            statusEl.className = `connection-status ${status}`;
            
            const icons = {
                loading: 'üîÑ',
                connected: '‚úÖ',
                error: '‚ùå'
            };
            
            statusEl.innerHTML = `${icons[status]} ${message}`;
            
            if (status === 'connected') {
                setTimeout(() => {
                    statusEl.style.opacity = '0.7';
                    statusEl.style.transform = 'scale(0.9)';
                }, 5000);
            }
        }

        // Navigation functionality
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                e.target.classList.add('active');
                
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.add('hidden');
                });
                
                const targetSection = e.target.getAttribute('data-section');
                document.getElementById(targetSection).classList.remove('hidden');
                
                // Initialize performance tab when navigating to it
                if (targetSection === 'performance') {
                    setTimeout(initializePerformanceTab, 100);
                }
            });
        });

        // Performance Chart Functions
        function initializePerformanceChart() {
            const canvas = document.getElementById('performanceChart');
            if (!canvas || performanceChart) return;
            
            const ctx = canvas.getContext('2d');
            
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Business Value Utvikling Over Tid',
                            font: {
                                size: 18,
                                weight: 'bold'
                            },
                            color: '#333'
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#333',
                            bodyColor: '#666',
                            borderColor: '#e0e0e0',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                title: function(context) {
                                    const date = new Date(context[0].parsed.x);
                                    return date.toLocaleDateString('no-NO');
                                },
                                afterBody: function(context) {
                                    const playerName = context[0].dataset.label;
                                    const date = new Date(context[0].parsed.x).toISOString().split('T')[0];
                                    const events = getEventsForDate(playerName, date);
                                    return events.length > 0 ? '\n' + events.join('\n') : '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'week',
                                displayFormats: {
                                    week: 'dd MMM'
                                }
                            },
                            title: {
                                display: true,
                                text: 'Tidslinje',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Business Value (NOK)',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('no-NO') + ' kr';
                                }
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 6,
                            hoverRadius: 8,
                            borderWidth: 2,
                            backgroundColor: '#fff'
                        },
                        line: {
                            borderWidth: 3,
                            tension: 0.1
                        }
                    }
                }
            });
        }

        function getEventsForDate(playerName, targetDate) {
            const breakdown = gameState.playerBreakdowns[playerName];
            if (!breakdown) return [];
            
            const events = [];
            
            if (breakdown.scenarioGains) {
                breakdown.scenarioGains.forEach(gain => {
                    if (gain.date === targetDate) {
                        events.push(`üé≤ ${gain.scenario}: ${gain.outcome} (${gain.value > 0 ? '+' : ''}${gain.value.toLocaleString()} NOK)`);
                    }
                });
            }
            
            if (breakdown.penalties) {
                breakdown.penalties.forEach(penalty => {
                    if (penalty.date === targetDate) {
                        events.push(`‚ö†Ô∏è ${penalty.type}: ${penalty.value.toLocaleString()} NOK`);
                    }
                });
            }
            
            if (breakdown.bonuses) {
                breakdown.bonuses.forEach(bonus => {
                    if (bonus.date === targetDate) {
                        events.push(`üéâ ${bonus.type}: +${bonus.value.toLocaleString()} NOK`);
                    }
                });
            }
            
            return events;
        }

        function generateTimeSeriesDataForPlayer(playerName) {
            const breakdown = gameState.playerBreakdowns[playerName];
            if (!breakdown) {
                const player = gameState.players.find(p => p.name === playerName);
                if (!player) return [];
                
                return [
                    { x: '2024-01-01', y: 500000 },
                    { x: new Date().toISOString().split('T')[0], y: player.businessValue }
                ];
            }
            
            const events = [];
            
            events.push({
                date: '2024-01-01',
                value: breakdown.startCapital || 500000,
                type: 'start'
            });
            
            if (breakdown.scenarioGains) {
                breakdown.scenarioGains.forEach(gain => {
                    events.push({
                        date: gain.date,
                        value: gain.value,
                        type: 'scenario',
                        details: gain
                    });
                });
            }
            
            if (breakdown.penalties) {
                breakdown.penalties.forEach(penalty => {
                    events.push({
                        date: penalty.date,
                        value: penalty.value,
                        type: 'penalty',
                        details: penalty
                    });
                });
            }
            
            if (breakdown.bonuses) {
                breakdown.bonuses.forEach(bonus => {
                    events.push({
                        date: bonus.date,
                        value: bonus.value,
                        type: 'bonus',
                        details: bonus
                    });
                });
            }
            
            events.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            let runningTotal = breakdown.startCapital || 500000;
            const timeSeriesData = [{
                x: events[0].date,
                y: runningTotal
            }];
            
            for (let i = 1; i < events.length; i++) {
                const event = events[i];
                runningTotal += event.value;
                timeSeriesData.push({
                    x: event.date,
                    y: runningTotal
                });
            }
            
            return timeSeriesData;
        }

        function createPerformancePlayerToggles() {
            const container = document.getElementById('player-toggles');
            if (!container) return;
            
            container.innerHTML = '';
            
            gameState.players.forEach((player, index) => {
                const color = playerColors[index % playerColors.length];
                
                const toggle = document.createElement('div');
                toggle.className = 'player-toggle';
                toggle.innerHTML = `
                    <input type="checkbox" 
                           id="perf-player-${index}" 
                           class="player-checkbox"
                           ${index < 2 ? 'checked' : ''}>
                    <label for="perf-player-${index}" style="cursor: pointer; flex-grow: 1;">
                        ${player.name}
                    </label>
                    <div class="player-color" style="background-color: ${color};"></div>
                `;
                
                const checkbox = toggle.querySelector('input');
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        visiblePerformancePlayers.add(player.name);
                    } else {
                        visiblePerformancePlayers.delete(player.name);
                    }
                    updatePerformanceChart();
                });
                
                if (checkbox.checked) {
                    visiblePerformancePlayers.add(player.name);
                }
                
                container.appendChild(toggle);
            });
        }

        function updatePerformanceChart() {
            if (!performanceChart) return;
            
            const datasets = [];
            
            Array.from(visiblePerformancePlayers).forEach((playerName, index) => {
                const playerIndex = gameState.players.findIndex(p => p.name === playerName);
                const color = playerColors[playerIndex % playerColors.length];
                const data = generateTimeSeriesDataForPlayer(playerName);
                
                datasets.push({
                    label: playerName,
                    data: data,
                    borderColor: color,
                    backgroundColor: color + '20',
                    fill: false,
                    pointBackgroundColor: color,
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: color,
                    pointHoverBorderColor: '#fff'
                });
            });
            
            performanceChart.data.datasets = datasets;
            performanceChart.update('active');
            
            updatePerformanceStats();
        }

        function updatePerformanceStats() {
            const visiblePlayersArray = Array.from(visiblePerformancePlayers);
            
            const bestPerformerEl = document.getElementById('best-performer');
            const mostConsistentEl = document.getElementById('most-consistent');
            const biggestSwingEl = document.getElementById('biggest-swing');
            const totalEventsEl = document.getElementById('total-events');
            
            if (!bestPerformerEl) return;
            
            if (visiblePlayersArray.length === 0) {
                bestPerformerEl.textContent = '-';
                mostConsistentEl.textContent = '-';
                biggestSwingEl.textContent = '-';
                totalEventsEl.textContent = '-';
                return;
            }
            
            let bestPerformer = '';
            let maxGrowth = -Infinity;
            let mostConsistent = '';
            let minVariance = Infinity;
            let biggestSwing = '';
            let maxSwing = 0;
            let totalEvents = 0;
            
            visiblePlayersArray.forEach(playerName => {
                const breakdown = gameState.playerBreakdowns[playerName];
                const data = generateTimeSeriesDataForPlayer(playerName);
                
                if (data.length < 2) return;
                
                const startValue = data[0].y;
                const endValue = data[data.length - 1].y;
                const growth = endValue - startValue;
                
                if (growth > maxGrowth) {
                    maxGrowth = growth;
                    bestPerformer = playerName.split(' ')[0];
                }
                
                const values = data.map(d => d.y);
                const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
                const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
                
                if (variance < minVariance) {
                    minVariance = variance;
                    mostConsistent = playerName.split(' ')[0];
                }
                
                for (let i = 1; i < data.length; i++) {
                    const swing = Math.abs(data[i].y - data[i-1].y);
                    if (swing > maxSwing) {
                        maxSwing = swing;
                        biggestSwing = playerName.split(' ')[0];
                    }
                }
                
                if (breakdown) {
                    totalEvents += (breakdown.scenarioGains?.length || 0) + 
                                  (breakdown.penalties?.length || 0) + 
                                  (breakdown.bonuses?.length || 0);
                }
            });
            
            bestPerformerEl.textContent = bestPerformer || '-';
            mostConsistentEl.textContent = mostConsistent || '-';
            biggestSwingEl.textContent = biggestSwing || '-';
            totalEventsEl.textContent = totalEvents;
        }

        function initializePerformanceTab() {
            if (!performanceChart) {
                initializePerformanceChart();
            }
            createPerformancePlayerToggles();
            updatePerformanceChart();
        }

        // Load data functions
        function loadPlayersFromSheets() {
            console.log('üîÑ Loading players from Google Sheets...');
            updateConnectionStatus('loading', 'Laster spillere...');
            
            const callbackName = 'loadPlayersCallback_' + Date.now();
            const script = document.createElement('script');
            
            window[callbackName] = function(response) {
                document.head.removeChild(script);
                delete window[callbackName];
                
                console.log('üìä Players response:', response);
                
                if (response && response.status === 'success' && response.data && response.data.length > 0) {
                    gameState.players = response.data.map((player, index) => ({
                        name: player.name || `Spiller ${index + 1}`,
                        company: player.company || player.name || `Selskap ${index + 1}`,
                        businessValue: parseInt(player.businessValue) || 500000,
                        rank: parseInt(player.rank) || (index + 1)
                    }));
                    
                    gameState.players.sort((a, b) => b.businessValue - a.businessValue);
                    gameState.players.forEach((player, index) => {
                        player.rank = index + 1;
                    });
                    
                    console.log('‚úÖ Players loaded from Google Sheets database:', gameState.players.length, 'players');
                    
                    renderLeaderboard();
                    updateStats();
                    updateConnectionStatus('connected', 'Live data fra Sheets');
                    
                    addNotification(`üìä ${gameState.players.length} spillere lastet fra Google Sheets database!`);
                } else {
                    console.log('‚ÑπÔ∏è No players found in Google Sheets - database is empty');
                    updateConnectionStatus('connected', 'Tilkoblet (database tom)');
                    addNotification(`‚ÑπÔ∏è Google Sheets database er tom. Legg til spillere i admin panel.`);
                }
                
                const savedBreakdowns = localStorage.getItem('tripletex_player_breakdowns');
                if (savedBreakdowns) {
                    gameState.playerBreakdowns = JSON.parse(savedBreakdowns);
                }
            };
            
            script.onerror = function() {
                document.head.removeChild(script);
                delete window[callbackName];
                updateConnectionStatus('error', 'Feil ved lasting av spillere');
                console.log('‚ùå Failed to load players from Google Sheets');
                addNotification(`‚ùå Kunne ikke laste spillerdata fra Google Sheets database.`);
            };
            
            script.src = GOOGLE_SHEETS_URL + '?callback=' + callbackName + '&action=getPlayers';
            document.head.appendChild(script);
            
            setTimeout(() => {
                if (document.head.contains(script)) {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    updateConnectionStatus('error', 'Timeout ved lasting av spillere');
                    console.log('‚ùå Players loading timeout');
                    addNotification(`‚è∞ Timeout ved lasting fra Google Sheets database.`);
                }
            }, 15000);
        }

        function loadScenarioFromSheets() {
            console.log('üîÑ Loading scenario from Google Sheets...');
            
            const callbackName = 'loadScenarioCallback_' + Date.now();
            const script = document.createElement('script');
            
            window[callbackName] = function(response) {
                document.head.removeChild(script);
                delete window[callbackName];
                
                console.log('üé≤ Scenario response:', response);
                
                if (response && response.status === 'success' && response.message === 'Choice recorded successfully') {
                    console.log('‚ö†Ô∏è Got choices response instead of scenario - Google Apps Script routing issue');
                    addNotification(`‚ö†Ô∏è Scenario loading har routing-problem i Google Apps Script`);
                    return;
                }
                
                if (response && response.status === 'success' && response.data) {
                    gameState.currentScenario = {
                        id: response.data.id,
                        title: response.data.title || 'Nytt Scenario',
                        background: response.data.background || '',
                        deadline: response.data.deadline || '',
                        tasks: response.data.tasks || [],
                        choices: response.data.choices || {},
                        results: response.data.results || {}
                    };
                    
                    console.log('‚úÖ Scenario loaded from Google Sheets:', gameState.currentScenario.title);
                    
                    renderScenario();
                    updateStats();
                    
                    addNotification(`üé≤ Scenario oppdatert: ${gameState.currentScenario.title}`);
                } else if (response && response.status === 'success' && !response.data) {
                    console.log('‚ÑπÔ∏è No scenario found in Google Sheets - database empty');
                    gameState.currentScenario = null;
                    renderScenario();
                    updateStats();
                    addNotification(`‚ÑπÔ∏è Ingen aktive scenarioer i Google Sheets database`);
                } else {
                    console.log('‚ùå Invalid scenario response:', response);
                    addNotification(`‚ùå Ugyldig scenario-respons fra Google Sheets`);
                }
            };
            
            script.onerror = function() {
                document.head.removeChild(script);
                delete window[callbackName];
                console.log('‚ùå Failed to load scenario from Google Sheets');
                addNotification(`‚ùå Kunne ikke laste scenario fra Google Sheets.`);
            };
            
            script.src = GOOGLE_SHEETS_URL + '?callback=' + callbackName + '&action=getCurrentScenario';
            document.head.appendChild(script);
            
            setTimeout(() => {
                if (document.head.contains(script)) {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    console.log('‚ùå Scenario loading timeout');
                }
            }, 15000);
        }

        function loadPlayerBreakdownsFromSheets() {
            const callbackName = 'loadBreakdownsCallback_' + Date.now();
            const script = document.createElement('script');
            
            window[callbackName] = function(response) {
                document.head.removeChild(script);
                delete window[callbackName];
                
                if (response && response.status === 'success') {
                    gameState.playerBreakdowns = response.data;
                    console.log('‚úÖ Player breakdowns loaded from Google Sheets:', Object.keys(response.data).length, 'players');
                    
                    renderLeaderboard();
                    if (performanceChart) {
                        updatePerformanceChart();
                    }
                } else {
                    console.log('‚ÑπÔ∏è No player breakdowns found in Google Sheets');
                }
            };
            
            script.onerror = function() {
                document.head.removeChild(script);
                delete window[callbackName];
                console.log('‚ùå Failed to load player breakdowns from Google Sheets');
            };
            
            script.src = GOOGLE_SHEETS_URL + '?callback=' + callbackName + '&action=getPlayerBreakdowns';
            document.head.appendChild(script);
        }

        // Render functions
        function renderLeaderboard() {
            const container = document.getElementById('leaderboard-content');
            
            if (!gameState.players || gameState.players.length === 0) {
                container.innerHTML = '<p>Ingen spillere registrert enn√•.</p>';
                return;
            }

            let html = '';
            gameState.players.forEach((player, index) => {
                const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
                
                const playerBreakdown = gameState.playerBreakdowns[player.name];
                let penaltyInfo = '';
                
                if (playerBreakdown && playerBreakdown.penalties && playerBreakdown.penalties.length > 0) {
                    const penalties = playerBreakdown.penalties;
                    const totalPenalties = penalties.reduce((sum, penalty) => sum + Number(penalty.value), 0);
                    const latestPenalty = penalties[penalties.length - 1];
                    
                    penaltyInfo = `
                        <div style="font-size: 0.8rem; color: #dc3545; margin-top: 0.3rem;">
                            <strong>Straffer:</strong> ${penalties.length} aktive (${totalPenalties.toLocaleString()} NOK totalt)<br>
                            <strong>Siste:</strong> ${latestPenalty.type} (${latestPenalty.value.toLocaleString()} NOK)
                        </div>
                    `;
                }
                
                html += `
                    <div class="leaderboard-item" 
                         onclick="showPlayerBreakdown('${player.name}')" 
                         title="Klikk for √• se ${player.name}'s detaljer"
                         data-player="${player.name}">
                        <span class="rank ${rankClass}">${player.rank}</span>
                        <div class="player-info">
                            <div class="player-name">${player.name}</div>
                            <div class="player-company">${player.company}</div>
                            ${penaltyInfo}
                        </div>
                        <span class="business-value">${player.businessValue.toLocaleString()} NOK</span>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function showPlayerBreakdown(playerName) {
            const existingBreakdown = document.querySelector('.breakdown.visible');
            if (existingBreakdown) {
                existingBreakdown.classList.remove('visible');
                existingBreakdown.remove();
            }
            
            const playerItem = document.querySelector(`[data-player="${playerName}"]`);
            if (!playerItem) return;
            
            const breakdownData = gameState.playerBreakdowns[playerName];
            if (!breakdownData) {
                const defaultBreakdown = {
                    startCapital: 500000,
                    scenarioGains: [],
                    penalties: [],
                    bonuses: []
                };
                const breakdownHTML = createBreakdownHTML(playerName, defaultBreakdown);
                playerItem.insertAdjacentHTML('afterend', breakdownHTML);
                return;
            }
            
            const breakdownHTML = createBreakdownHTML(playerName, breakdownData);
            playerItem.insertAdjacentHTML('afterend', breakdownHTML);
        }

        function createBreakdownHTML(playerName, breakdownData) {
            const totalScenarioGains = breakdownData.scenarioGains.reduce((sum, gain) => sum + Number(gain.value), 0);
            const totalPenalties = breakdownData.penalties.reduce((sum, penalty) => sum + Number(penalty.value), 0);
            const totalBonuses = breakdownData.bonuses.reduce((sum, bonus) => sum + Number(bonus.value), 0);
            const calculatedTotal = Number(breakdownData.startCapital) + totalScenarioGains + totalPenalties + totalBonuses;
            
            return `
                <div class="breakdown visible" id="breakdown-${playerName.replace(/\s+/g, '-')}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0; color: #0066CC;">${playerName}'s Breakdown</h4>
                        <button class="btn" onclick="closeBreakdown(this)" style="width: auto; padding: 0.25rem 0.75rem; font-size: 0.8rem; margin: 0;">‚úï</button>
                    </div>
                    
                    <div class="breakdown-section">
                        <div class="breakdown-title">üí∞ Start Kapital</div>
                        <div class="breakdown-item neutral">
                            <span>√Öpningsbalanse</span>
                            <span>${Number(breakdownData.startCapital).toLocaleString()} NOK</span>
                        </div>
                    </div>
                    
                    ${breakdownData.scenarioGains.length > 0 ? `
                    <div class="breakdown-section">
                        <div class="breakdown-title">üé≤ Scenario Resultater</div>
                        ${breakdownData.scenarioGains.map(gain => {
                            const value = Number(gain.value);
                            const colorClass = value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
                            const sign = value > 0 ? '+' : '';
                            
                            return `
                                <div class="breakdown-item ${colorClass}">
                                    <span>${gain.scenario} - Valg ${gain.choice}) ${gain.choiceTitle || ''}</span>
                                    <span>${sign}${value.toLocaleString()} NOK</span>
                                </div>
                                <div style="font-size: 0.8rem; color: #666; margin-left: 1rem; margin-bottom: 0.5rem;">
                                    <strong>${gain.outcome}</strong>${gain.description ? ` - ${gain.description}` : ''}
                                </div>
                            `;
                        }).join('')}
                        <div class="breakdown-item ${totalScenarioGains > 0 ? 'positive' : totalScenarioGains < 0 ? 'negative' : 'neutral'}" style="font-weight: bold; border-top: 2px solid ${totalScenarioGains > 0 ? '#28a745' : totalScenarioGains < 0 ? '#dc3545' : '#6c757d'}; padding-top: 0.5rem;">
                            <span>Total scenario gevinster</span>
                            <span>${totalScenarioGains > 0 ? '+' : ''}${totalScenarioGains.toLocaleString()} NOK</span>
                        </div>
                    </div>
                    ` : `
                    <div class="breakdown-section">
                        <div class="breakdown-title">üé≤ Scenario Resultater</div>
                        <div class="breakdown-item neutral">
                            <span>Ingen scenario gevinster enn√•</span>
                            <span>0 NOK</span>
                        </div>
                    </div>
                    `}
                    
                    ${breakdownData.penalties.length > 0 ? `
                    <div class="breakdown-section">
                        <div class="breakdown-title">‚ö†Ô∏è Straffer</div>
                        ${breakdownData.penalties.map(penalty => {
                            const value = Number(penalty.value);
                            const colorClass = value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
                            const sign = value > 0 ? '+' : '';
                            
                            return `
                                <div class="breakdown-item ${colorClass}">
                                    <span>${penalty.type} (${penalty.status}) - ${penalty.date}</span>
                                    <span>${sign}${value.toLocaleString()} NOK</span>
                                </div>
                                <div style="font-size: 0.8rem; color: #666; margin-left: 1rem; margin-bottom: 0.5rem;">
                                    ${penalty.reason}
                                </div>
                            `;
                        }).join('')}
                        <div class="breakdown-item ${totalPenalties > 0 ? 'positive' : totalPenalties < 0 ? 'negative' : 'neutral'}" style="font-weight: bold; border-top: 2px solid ${totalPenalties > 0 ? '#28a745' : totalPenalties < 0 ? '#dc3545' : '#6c757d'}; padding-top: 0.5rem;">
                            <span>Total straffer</span>
                            <span>${totalPenalties > 0 ? '+' : ''}${totalPenalties.toLocaleString()} NOK</span>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${breakdownData.bonuses.length > 0 ? `
                    <div class="breakdown-section">
                        <div class="breakdown-title">üéâ Bonuser</div>
                        ${breakdownData.bonuses.map(bonus => {
                            const value = Number(bonus.value);
                            const colorClass = value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
                            const sign = value > 0 ? '+' : '';
                            
                            return `
                                <div class="breakdown-item ${colorClass}">
                                    <span>${bonus.type} - ${bonus.date}</span>
                                    <span>${sign}${value.toLocaleString()} NOK</span>
                                </div>
                                <div style="font-size: 0.8rem; color: #666; margin-left: 1rem; margin-bottom: 0.5rem;">
                                    ${bonus.reason}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    ` : ''}
                    
                    <div class="breakdown-total">
                        üìä Total Business Value: ${calculatedTotal.toLocaleString()} NOK
                    </div>
                </div>
            `;
        }

        function closeBreakdown(button) {
            const breakdown = button.closest('.breakdown');
            if (breakdown) {
                breakdown.classList.remove('visible');
                breakdown.remove();
            }
        }

        function renderScenario() {
            const container = document.getElementById('scenario-content');
            
            if (!gameState.currentScenario) {
                container.innerHTML = `
                    <div class="scenario-card">
                        <h2>Ingen aktivt scenario</h2>
                        <p>Neste scenario kommer snart! Hold deg oppdatert p√• Dashboard.</p>
                        <p><em>Scenarioer styres av admin og oppdateres her n√•r de er aktive.</em></p>
                    </div>
                `;
                return;
            }

            const scenario = gameState.currentScenario;
            const deadline = scenario.deadline ? new Date(scenario.deadline) : null;
            const now = new Date();
            const timeLeft = deadline ? deadline - now : 0;
            const isExpired = timeLeft <= 0;
            
            let deadlineHtml = '';
            if (deadline && !isExpired) {
                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                
                const urgentClass = timeLeft < 24 * 60 * 60 * 1000 ? 'urgent' : '';
                deadlineHtml = `
                    <div class="scenario-deadline ${urgentClass}">
                        ‚è∞ Deadline: ${days}d ${hours}t ${minutes}m igjen
                    </div>
                `;
            } else if (deadline && isExpired) {
                deadlineHtml = `
                    <div class="scenario-deadline urgent">
                        ‚è∞ Deadline passert - venter p√• resultater
                    </div>
                `;
            }

            // Build tasks HTML if available
            let tasksHtml = '';
            if (scenario.tasks && scenario.tasks.length > 0) {
                tasksHtml = '<div class="scenario-tasks"><h3>üìã Obligatoriske Oppgaver:</h3>';
                
                scenario.tasks.forEach(task => {
                    tasksHtml += `
                        <div class="task-display">
                            <div class="task-number">${task.number}</div>
                            <div class="task-content">
                                <div class="task-title">${task.title}</div>
                                <div class="task-description">${task.description}</div>
                                <div class="task-rewards">
                                    ${task.reward ? `<div class="task-reward">‚úÖ ${task.reward}</div>` : ''}
                                    ${task.penalty ? `<div class="task-penalty">‚ùå ${task.penalty}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                tasksHtml += '</div>';
            }

            // Build choices HTML if available
            let choicesHtml = '';
            const hasResults = scenario.results && Object.keys(scenario.results).length > 0;
            if (scenario.choices && Object.keys(scenario.choices).length > 0 && !hasResults) {
                choicesHtml = '<div class="scenario-choices"><h3>üìã Valgalternativer:</h3>';
                
                Object.entries(scenario.choices).forEach(([key, choice]) => {
                    if (typeof choice === 'string') {
                        choicesHtml += `
                            <div class="choice-display">
                                <div class="choice-letter">${key})</div>
                                <div class="choice-content">
                                    <div class="choice-title">${choice}</div>
                                </div>
                            </div>
                        `;
                    } else {
                        choicesHtml += `
                            <div class="choice-display">
                                <div class="choice-letter">${key})</div>
                                <div class="choice-content">
                                    <div class="choice-title">${choice.title || choice}</div>
                                    ${choice.cost ? `<div class="choice-cost">üí∞ ${choice.cost}</div>` : ''}
                                    ${choice.potential ? `<div class="choice-potential">üéØ ${choice.potential}</div>` : ''}
                                    ${choice.odds ? `<div class="choice-odds">üé≤ ${choice.odds}</div>` : ''}
                                </div>
                            </div>
                        `;
                    }
                });
                choicesHtml += '</div>';
                
                if (!isExpired) {
                    choicesHtml += `
                        <div class="scenario-note">
                            <p><strong>üìù Hvordan delta:</strong></p>
                            <p>Klikk p√• ditt √∏nskede valg for √• registrere det automatisk!</p>
                        </div>
                    `;
                } else {
                    choicesHtml += `
                        <div class="scenario-note">
                            <p><strong>‚è∞ Valg-periode avsluttet</strong></p>
                            <p>Venter p√• business-resultater...</p>
                        </div>
                    `;
                }
            }

            // Build results HTML if available
            let resultsHtml = '';
            if (scenario.results && Object.keys(scenario.results).length > 0) {
                resultsHtml = `
                    <div class="scenario-results">
                        <h3>üéä Scenario Resultater!</h3>
                        <div class="results-grid">
                `;
                
                Object.entries(scenario.results).forEach(([playerName, result]) => {
                    resultsHtml += `
                        <div class="result-item">
                            <div class="result-player">${playerName}</div>
                            <div class="result-choice">Valg: ${result.choice}) ${result.choiceTitle || result.choice}</div>
                            <div class="result-outcome">${result.outcome}</div>
                            ${result.description ? `<div style="font-size: 0.9rem; color: #666; margin: 0.5rem 0;">${result.description}</div>` : ''}
                            <div class="result-value ${result.valueChange >= 0 ? 'positive' : 'negative'}">
                                ${result.valueChange >= 0 ? '+' : ''}${result.valueChange.toLocaleString()} NOK
                            </div>
                        </div>
                    `;
                });
                
                resultsHtml += `
                        </div>
                        <div class="scenario-note">
                            <p><strong>üíº Neste steg:</strong> Implementer effektene i ditt Tripletex-regnskap!</p>
                        </div>
                    </div>
                `;
            }

            // Combine all HTML parts
            container.innerHTML = `
                <div class="scenario-card">
                    <h2>${scenario.title}</h2>
                    ${scenario.background ? `<p>${scenario.background}</p>` : 
                      scenario.description ? `<p>${scenario.description}</p>` : ''}
                    ${deadlineHtml}
                    ${tasksHtml}
                    ${choicesHtml}
                    ${resultsHtml}
                </div>
            `;
            
            // Make choices clickable after rendering
            setTimeout(() => {
                makeChoicesClickable();
            }, 100);
        }

        function updateStats() {
            document.getElementById('total-players').textContent = gameState.players.length;
            
            if (gameState.players.length > 0) {
                const leader = gameState.players[0];
                document.getElementById('current-leader').textContent = leader.name.split(' ')[0];
                
                const avgValue = gameState.players.reduce((sum, p) => sum + p.businessValue, 0) / gameState.players.length;
                document.getElementById('avg-value').textContent = avgValue.toLocaleString();
            }

            const scenarioStatusEl = document.getElementById('scenario-status');
            if (gameState.currentScenario) {
                const deadline = gameState.currentScenario.deadline ? new Date(gameState.currentScenario.deadline) : null;
                const now = new Date();
                
                if (gameState.currentScenario.results) {
                    scenarioStatusEl.textContent = 'Resultater klar';
                } else if (deadline && deadline < now) {
                    scenarioStatusEl.textContent = 'Venter resultater';
                } else if (deadline) {
                    scenarioStatusEl.textContent = 'Aktiv';
                } else {
                    scenarioStatusEl.textContent = 'Planlagt';
                }
            } else {
                scenarioStatusEl.textContent = 'Ingen aktive';
            }
        }

        function addNotification(message, type = 'info') {
            gameState.notifications.unshift({
                message,
                type,
                timestamp: new Date(),
                id: Date.now()
            });
            renderNotifications();
            
            setTimeout(() => {
                gameState.notifications = gameState.notifications.filter(n => n.id !== gameState.notifications[0].id);
                renderNotifications();
            }, 10000);
        }

        function renderNotifications() {
            const container = document.getElementById('notifications');
            
            if (gameState.notifications.length === 0) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            gameState.notifications.slice(0, 3).forEach(notification => {
                html += `
                    <div class="notification">
                        üì¢ ${notification.message}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Choice interaction functions
        function makeChoicesClickable() {
            const choiceElements = document.querySelectorAll('.choice-display');
            
            choiceElements.forEach((choiceEl) => {
                if (choiceEl.hasAttribute('data-clickable')) return;
                choiceEl.setAttribute('data-clickable', 'true');
                
                let choiceLetter = '';
                const choiceLetterEl = choiceEl.querySelector('.choice-letter');
                if (choiceLetterEl) {
                    choiceLetter = choiceLetterEl.textContent.replace(')', '');
                } else {
                    const choiceTitle = choiceEl.querySelector('.choice-title').textContent;
                    const letterMatch = choiceTitle.match(/^([A-Z])\)/);
                    choiceLetter = letterMatch ? letterMatch[1] : 'A';
                }
                
                choiceEl.style.cursor = 'pointer';
                choiceEl.style.transition = 'all 0.3s ease';
                
                choiceEl.addEventListener('mouseenter', () => {
                    choiceEl.style.transform = 'translateX(5px)';
                    choiceEl.style.boxShadow = '0 4px 15px rgba(0,0,0,0.1)';
                });
                
                choiceEl.addEventListener('mouseleave', () => {
                    choiceEl.style.transform = 'translateX(0)';
                    choiceEl.style.boxShadow = 'none';
                });
                
                choiceEl.addEventListener('click', async () => {
                    const playerName = prompt('Skriv inn ditt navn for √• velge dette alternativet:');
                    if (playerName && playerName.trim()) {
                        const choiceTitle = choiceEl.querySelector('.choice-title').textContent;
                        const confirmed = confirm(`${playerName}, bekrefter du valg ${choiceLetter}: ${choiceTitle}?`);
                        
                        if (confirmed) {
                            await sendChoiceToSheets(choiceEl, choiceLetter, choiceTitle, playerName.trim());
                        }
                    }
                });
                
                const choiceContent = choiceEl.querySelector('.choice-content');
                if (choiceContent && !choiceContent.querySelector('.click-hint')) {
                    const clickHint = document.createElement('div');
                    clickHint.innerHTML = 'üëÜ Klikk for √• velge';
                    clickHint.className = 'click-hint';
                    clickHint.style.cssText = 'font-size: 0.8rem; color: #0066CC; margin-top: 0.5rem; opacity: 0.7;';
                    choiceContent.appendChild(clickHint);
                }
            });
        }

        async function sendChoiceToSheets(choiceEl, choiceLetter, choiceTitle, playerName) {
            const originalBg = choiceEl.style.backgroundColor;
            choiceEl.style.backgroundColor = '#fff3cd';
            choiceEl.style.borderColor = '#ffc107';
            
            const loadingEl = document.createElement('div');
            loadingEl.innerHTML = '‚è≥ Sender valg...';
            loadingEl.style.cssText = 'font-size: 0.8rem; color: #856404; margin-top: 0.5rem; font-weight: bold;';
            choiceEl.appendChild(loadingEl);
            
            const choiceData = {
                player: playerName,
                choice: choiceLetter,
                choiceTitle: choiceTitle,
                scenarioTitle: gameState.currentScenario ? gameState.currentScenario.title : 'Unknown Scenario',
                week: 'Current',
                timestamp: new Date().toISOString()
            };
            
            try {
                await new Promise((resolve, reject) => {
                    const callbackName = 'choiceCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                    const script = document.createElement('script');
                    
                    window[callbackName] = function(response) {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        
                        if (response && response.status === 'success') {
                            resolve(true);
                        } else {
                            reject(new Error(response ? response.message : 'Unknown error'));
                        }
                    };
                    
                    script.onerror = function() {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        reject(new Error('Failed to load script'));
                    };
                    
                    const params = new URLSearchParams({
                        callback: callbackName,
                        player: choiceData.player,
                        choice: choiceData.choice,
                        choiceTitle: choiceData.choiceTitle,
                        scenarioTitle: choiceData.scenarioTitle,
                        week: choiceData.week,
                        timestamp: choiceData.timestamp
                    });
                    
                    script.src = GOOGLE_SHEETS_URL + '?' + params.toString();
                    document.head.appendChild(script);
                    
                    setTimeout(() => {
                        if (document.head.contains(script)) {
                            document.head.removeChild(script);
                            delete window[callbackName];
                            reject(new Error('Request timeout'));
                        }
                    }, 10000);
                });
                
                choiceEl.removeChild(loadingEl);
                choiceEl.style.backgroundColor = '#d4edda';
                choiceEl.style.borderColor = '#28a745';
                
                alert(`‚úÖ Valg registrert: ${choiceLetter}) ${choiceTitle}\n\nDitt valg er sendt til admin og lagret i systemet!`);
                
                const successEl = document.createElement('div');
                successEl.innerHTML = '‚úÖ Valg registrert!';
                successEl.style.cssText = 'font-size: 0.8rem; color: #155724; margin-top: 0.5rem; font-weight: bold;';
                choiceEl.appendChild(successEl);
                
                choiceEl.style.pointerEvents = 'none';
                choiceEl.style.opacity = '0.8';
                
                addNotification(`‚úÖ ${playerName} valgte ${choiceLetter}: ${choiceTitle}`);
                
            } catch (error) {
                console.error('Error sending choice:', error);
                
                if (choiceEl.contains(loadingEl)) {
                    choiceEl.removeChild(loadingEl);
                }
                
                choiceEl.style.backgroundColor = '#f8d7da';
                choiceEl.style.borderColor = '#dc3545';
                
                alert('‚ùå Feil ved sending av valg: ' + error.message + '\n\nPr√∏v igjen eller kontakt admin.');
                
                setTimeout(() => {
                    choiceEl.style.backgroundColor = originalBg;
                    choiceEl.style.borderColor = '';
                }, 3000);
            }
        }

        // Global update function for admin panel
        window.updateGameData = function(newData) {
            if (newData.players) {
                gameState.players = newData.players;
                renderLeaderboard();
                updateStats();
            }
            if (newData.playerBreakdowns) {
                gameState.playerBreakdowns = newData.playerBreakdowns;
            }
            if (newData.scenario) {
                gameState.currentScenario = newData.scenario;
                renderScenario();
            }
            if (newData.notification) {
                addNotification(newData.notification.message, newData.notification.type);
            }
        };

        // Auto-refresh countdown timer every minute
        function startAutoRefresh() {
            setInterval(() => {
                if (gameState.currentScenario && gameState.currentScenario.deadline) {
                    renderScenario();
                    updateStats();
                }
                
                loadScenarioFromSheets();
            }, 120000);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                loadPlayersFromSheets();
                loadScenarioFromSheets();
            }, 2000);
            
            setTimeout(() => {
                loadPlayerBreakdownsFromSheets();
            }, 4000);
            
            renderLeaderboard();
            renderScenario();
            updateStats();
            startAutoRefresh();
            
            addNotification('Velkommen til Suppa Business League! Klikk p√• spillere for √• se detaljer. üéâ');
        });
    </script>
</body>
</html>
                
