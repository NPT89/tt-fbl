<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suppa Business League</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0066CC 0%, #00A651 100%);
            min-height: 100vh;
            color: #333;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem 0;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            color: #0066CC;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .nav-links a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.3s ease;
            cursor: pointer;
        }

        .nav-links a:hover, .nav-links a.active {
            color: #0066CC;
        }

        .main-content {
            padding: 2rem 0;
        }

        .dashboard {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(145deg, #f0f0f0, #ffffff);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #0066CC;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .leaderboard {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .leaderboard h2 {
            margin-bottom: 1.5rem;
            color: #333;
            text-align: center;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(145deg, #f9f9f9, #ffffff);
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .leaderboard-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .rank {
            font-weight: bold;
            font-size: 1.2rem;
            color: #0066CC;
            min-width: 40px;
        }

        .rank.gold { color: #FFD700; }
        .rank.silver { color: #C0C0C0; }
        .rank.bronze { color: #CD7F32; }

        .player-info {
            flex-grow: 1;
            margin-left: 1rem;
        }

        .player-name {
            font-weight: bold;
            margin-bottom: 0.2rem;
        }

        .player-company {
            color: #666;
            font-size: 0.9rem;
        }

        .business-value {
            font-weight: bold;
            color: #28a745;
            font-size: 1.1rem;
        }

        .breakdown {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-top: 0.5rem;
            padding: 1rem;
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        .breakdown.visible {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
                padding: 0 1rem;
            }
            to {
                opacity: 1;
                max-height: 500px;
                padding: 1rem;
            }
        }

        .breakdown-section {
            margin-bottom: 1rem;
            border-left: 3px solid #0066CC;
            padding-left: 1rem;
        }

        .breakdown-section:last-child {
            margin-bottom: 0;
        }

        .breakdown-title {
            font-weight: bold;
            color: #0066CC;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            border-bottom: 1px solid #e9ecef;
        }

        .breakdown-item:last-child {
            border-bottom: none;
        }

        .breakdown-item.positive {
            color: #28a745;
        }

        .breakdown-item.negative {
            color: #dc3545;
        }

        .breakdown-item.neutral {
            color: #6c757d;
        }

        .breakdown-total {
            background: #0066CC;
            color: white;
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 0.5rem;
            font-weight: bold;
            text-align: center;
        }

        .scenario-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .scenario-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .scenario-deadline {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: bold;
        }

        /* NEW TASK STYLING */
        .scenario-tasks {
            margin: 1.5rem 0;
        }

        .task-display {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(145deg, #f8f9ff, #ffffff);
            border-radius: 12px;
            border-left: 4px solid #0066CC;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .task-display:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .task-number {
            font-weight: bold;
            font-size: 1.3rem;
            color: #0066CC;
            min-width: 35px;
            background: rgba(0, 102, 204, 0.1);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .task-content {
            flex-grow: 1;
        }

        .task-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .task-description {
            color: #666;
            margin-bottom: 0.75rem;
            line-height: 1.5;
        }

        .task-rewards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .task-reward {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
            font-weight: bold;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.9rem;
            border: 1px solid rgba(40, 167, 69, 0.2);
        }

        .task-penalty {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            font-weight: bold;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.9rem;
            border: 1px solid rgba(220, 53, 69, 0.2);
        }

        .scenario-choices {
            margin: 1.5rem 0;
        }

        .choice-display {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background: linear-gradient(145deg, #f9f9f9, #ffffff);
            border-radius: 8px;
            border-left: 4px solid #0066CC;
        }

        .choice-letter {
            font-weight: bold;
            font-size: 1.2rem;
            color: #0066CC;
            min-width: 30px;
        }

        .choice-content {
            flex-grow: 1;
        }

        .choice-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .choice-cost {
            color: #dc3545;
            font-weight: bold;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .choice-potential {
            color: #28a745;
            font-weight: bold;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .choice-odds {
            color: #666;
            font-size: 0.85rem;
        }

        .scenario-note {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .scenario-note p {
            margin-bottom: 0.5rem;
        }

        .scenario-note p:last-child {
            margin-bottom: 0;
        }

        .scenario-results {
            margin-top: 2rem;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .result-item {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #0066CC;
        }

        .result-player {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: #0066CC;
        }

        .result-choice, .result-dice, .result-outcome {
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
            color: #666;
        }

        .result-value {
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 0.5rem;
        }

        .result-value.positive {
            color: #28a745;
        }

        .result-value.negative {
            color: #dc3545;
        }

        .btn {
            background: linear-gradient(145deg, #0066CC, #00A651);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .notification {
            background: #cce7ff;
            border: 1px solid #99d6ff;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hidden {
            display: none;
        }

        /* NEW - Connection status indicator */
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 0.75rem 1rem;
            border-radius: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            font-size: 0.85rem;
            font-weight: 500;
            z-index: 1000;
            transition: all 0.3s ease;
            border: 2px solid #e0e0e0;
            min-width: 180px;
            text-align: center;
        }

        .connection-status.connected {
            color: #28a745;
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }

        .connection-status.loading {
            color: #ffc107;
            border-color: #ffc107;
            background: rgba(255, 193, 7, 0.1);
        }

        .connection-status.error {
            color: #dc3545;
            border-color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            .nav {
                flex-direction: column;
                text-align: center;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .task-display {
                flex-direction: column;
                gap: 0.75rem;
            }

            .task-number {
                align-self: flex-start;
            }

            .task-rewards {
                grid-template-columns: 1fr;
            }

            .connection-status {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 1rem;
            }
        }
.task-description {
    white-space: pre-line;
    line-height: 1.5;
    font-size: 0.95rem;
    min-height: 60px;
    height: auto;
    padding: 0.75rem;
    background: #f8f9ff; /* NY BL√Ö BAKGRUNN */
    color: #2c3e50; /* NY M√òRK TEKST */
    border: 1px solid #e3f2fd; /* NY BL√Ö BORDER */
    border-radius: 6px;
    margin-bottom: 0.75rem;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* Styling for lister i task descriptions */
.task-description ul {
    margin: 0.5rem 0;
    padding-left: 1.5rem;
}

.task-description li {
    margin-bottom: 0.25rem;
}

/* Styling for bold tekst i descriptions */
.task-description strong {
    color: #495057;
    font-weight: 600;
}

/* Scrollbar styling for better appearance */
.task-description::-webkit-scrollbar {
    width: 6px;
}

.task-description::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.task-description::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 3px;
}

.task-description::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* Ensure task display has consistent spacing */
.task-display {
    padding: 1.5rem;
    margin-bottom: 1rem;
    background: linear-gradient(145deg, #f8f9ff, #ffffff);
    border-radius: 12px;
    border-left: 4px solid #0066CC;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .task-description {
        font-size: 0.9rem;
        max-height: 100px;
        padding: 0.6rem;
    }
        }

        .task-description,
        .task-content {
            background: #f8f9ff !important;
            color: #2c3e50 !important;
            border: 1px solid #e3f2fd !important;
            border-radius: 6px !important;
            padding: 0.75rem !important;
            white-space: pre-line !important;
            line-height: 1.5 !important;
        }

    </style>
</head>
<body>
    <!-- Connection status indicator -->
    <div id="connection-status" class="connection-status loading">
        üîÑ Kobler til Google Sheets...
    </div>

    <header class="header">
        <div class="container">
            <nav class="nav">
                <div class="logo">üèÜ Suppa Business League</div>
                <div class="nav-links">
                    <a class="nav-link active" data-section="dashboard">Dashboard</a>
                    <a class="nav-link" data-section="scenario">Scenario</a>
                    <a class="nav-link" data-section="help">Hjelp</a>
                </div>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <!-- Dashboard Section -->
            <section id="dashboard" class="section">
                <div class="dashboard">
                    <h1>Velkommen til Suppa Business League! üöÄ</h1>
                    <p><strong>Uke <span id="current-week">1</span> av 12</strong> - <span id="current-phase">Foundation Phase</span></p>
                    
                    <div id="notifications" class="notifications"></div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="total-players">4</div>
                            <div class="stat-label">Aktive Spillere</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="current-leader">Ingen leder</div>
                            <div class="stat-label">N√•v√¶rende Leder</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="avg-value">500,000</div>
                            <div class="stat-label">Gjennomsnitt (NOK)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="scenario-status">Venter</div>
                            <div class="stat-label">Scenario Status</div>
                        </div>
                    </div>
                </div>

                <div class="leaderboard" id="leaderboard-container">
                    <h2>üèÜ Leaderboard</h2>
                    <div id="leaderboard-content">
                        <p>Leaderboard lastes...</p>
                    </div>
                </div>
            </section>

            <!-- Scenario Section -->
            <section id="scenario" class="section hidden">
                <div class="scenario-section">
                    <div id="scenario-content">
                        <div class="scenario-card">
                            <h2>Ingen aktivt scenario</h2>
                            <p>Neste scenario kommer snart! Hold deg oppdatert p√• Dashboard.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Help Section -->
            <section id="help" class="section hidden">
                <div class="dashboard">
                    <h2>üéÆ Hvordan spille</h2>
                    
                    <h3>üìã Regler</h3>
                    <p><strong>M√•l:</strong> F√• h√∏yest Business Value etter 12 uker</p>
                    <p><strong>Start:</strong> 500,000 NOK p√• bankkonto</p>
                    <p><strong>Strategi:</strong> Velg smarte risiko/reward scenarioer</p>
                    
                    <h3>üé≤ Scenarioer</h3>
                    <p>Hver m√•ned f√•r du et scenario med 3-4 valg. H√∏yere risiko = h√∏yere potensial!</p>
                    <p>Business-logikk avgj√∏r utfall basert p√• strategiske beslutninger.</p>
                    
                    <h3>‚ö†Ô∏è Straffer</h3>
                    <p>Feil i Tripletex gir automatiske kostnader:</p>
                    <ul style="margin: 1rem 0; padding-left: 2rem;">
                        <li>Feil √•pningsbalanse: -50,000 NOK</li>
                        <li>Feil MVA-oppsett: -25,000 NOK/dag</li>
                        <li>Manglende f√∏rste salg: -10,000 NOK/dag</li>
                        <li>Feil kontokoder: -5,000 NOK per feil</li>
                    </ul>
                    
                    <h3>üèÜ Vinnere</h3>
                    <p>H√∏yest Business Value etter 12 uker vinner!</p>
                    <p>Det teller b√•de scenario-gevinster og regnskaps-n√∏yaktighet.</p>
                    
                    <h3>üëÅÔ∏è Transparency</h3>
                    <p><strong>Klikk p√• hvem som helst</strong> i leaderboard for √• se deres detaljerte breakdown!</p>
                    <p>Alt er √•pent og transparent - l√¶r av hverandres strategier og resultater.</p>
                </div>
            </section>
        </div>
    </main>

    <script>
        // GOOGLE SHEETS CONFIGURATION - UPDATED URL
        const GOOGLE_SHEETS_URL = 'https://script.google.com/a/macros/visma.com/s/AKfycby8O4wZLmoG6e-W1w9GVZUBwlRkhNMQyKZnBhEIfGiyUM_yNWwTNnV3-dP0kJ5H9HNUJQ/exec';

        // STEG 4: Make choices clickable and send to Google Sheets
        function makeChoicesClickable() {
            const choiceElements = document.querySelectorAll('.choice-display');
            
            choiceElements.forEach((choiceEl) => {
                // Skip if already clickable
                if (choiceEl.hasAttribute('data-clickable')) return;
                choiceEl.setAttribute('data-clickable', 'true');
                
                // Get choice letter from the choice-letter element or extract from title
                let choiceLetter = '';
                const choiceLetterEl = choiceEl.querySelector('.choice-letter');
                if (choiceLetterEl) {
                    choiceLetter = choiceLetterEl.textContent.replace(')', '');
                } else {
                    // Extract from choice title (A), B), etc.)
                    const choiceTitle = choiceEl.querySelector('.choice-title').textContent;
                    const letterMatch = choiceTitle.match(/^([A-Z])\)/);
                    choiceLetter = letterMatch ? letterMatch[1] : 'A';
                }
                
                // Add click styling
                choiceEl.style.cursor = 'pointer';
                choiceEl.style.transition = 'all 0.3s ease';
                
                // Add hover effects
                choiceEl.addEventListener('mouseenter', () => {
                    choiceEl.style.transform = 'translateX(5px)';
                    choiceEl.style.boxShadow = '0 4px 15px rgba(0,0,0,0.1)';
                });
                
                choiceEl.addEventListener('mouseleave', () => {
                    choiceEl.style.transform = 'translateX(0)';
                    choiceEl.style.boxShadow = 'none';
                });
                
                // Add click handler
                choiceEl.addEventListener('click', async () => {
                    const playerName = prompt('Skriv inn ditt navn for √• velge dette alternativet:');
                    if (playerName && playerName.trim()) {
                        const choiceTitle = choiceEl.querySelector('.choice-title').textContent;
                        const confirmed = confirm(`${playerName}, bekrefter du valg ${choiceLetter}: ${choiceTitle}?`);
                        
                        if (confirmed) {
                            await sendChoiceToSheets(choiceEl, choiceLetter, choiceTitle, playerName.trim());
                        }
                    }
                });
                
                // Add visual indication that choices are clickable
                const choiceContent = choiceEl.querySelector('.choice-content');
                if (choiceContent && !choiceContent.querySelector('.click-hint')) {
                    const clickHint = document.createElement('div');
                    clickHint.innerHTML = 'üëÜ Klikk for √• velge';
                    clickHint.className = 'click-hint';
                    clickHint.style.cssText = 'font-size: 0.8rem; color: #0066CC; margin-top: 0.5rem; opacity: 0.7;';
                    choiceContent.appendChild(clickHint);
                }
            });
        }

        // Function to send choice to Google Sheets
        async function sendChoiceToSheets(choiceEl, choiceLetter, choiceTitle, playerName) {
            const originalBg = choiceEl.style.backgroundColor;
            choiceEl.style.backgroundColor = '#fff3cd';
            choiceEl.style.borderColor = '#ffc107';
            
            // Add loading indicator
            const loadingEl = document.createElement('div');
            loadingEl.innerHTML = '‚è≥ Sender valg...';
            loadingEl.style.cssText = 'font-size: 0.8rem; color: #856404; margin-top: 0.5rem; font-weight: bold;';
            choiceEl.appendChild(loadingEl);
            
            const choiceData = {
                player: playerName,
                choice: choiceLetter,
                choiceTitle: choiceTitle,
                scenarioTitle: gameState.currentScenario ? gameState.currentScenario.title : 'Unknown Scenario',
                week: 'Current',
                timestamp: new Date().toISOString()
            };
            
            try {
                // Use JSONP to send choice to Google Sheets (same method as admin)
                await new Promise((resolve, reject) => {
                    const callbackName = 'choiceCallback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                    const script = document.createElement('script');
                    
                    window[callbackName] = function(response) {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        
                        if (response && response.status === 'success') {
                            resolve(true);
                        } else {
                            reject(new Error(response ? response.message : 'Unknown error'));
                        }
                    };
                    
                    script.onerror = function() {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        reject(new Error('Failed to load script'));
                    };
                    
                    const params = new URLSearchParams({
                        callback: callbackName,
                        player: choiceData.player,
                        choice: choiceData.choice,
                        choiceTitle: choiceData.choiceTitle,
                        scenarioTitle: choiceData.scenarioTitle,
                        week: choiceData.week,
                        timestamp: choiceData.timestamp
                    });
                    
                    script.src = GOOGLE_SHEETS_URL + '?' + params.toString();
                    document.head.appendChild(script);
                    
                    // Timeout after 10 seconds
                    setTimeout(() => {
                        if (document.head.contains(script)) {
                            document.head.removeChild(script);
                            delete window[callbackName];
                            reject(new Error('Request timeout'));
                        }
                    }, 10000);
                });
                
                // Success
                choiceEl.removeChild(loadingEl);
                choiceEl.style.backgroundColor = '#d4edda';
                choiceEl.style.borderColor = '#28a745';
                
                alert(`‚úÖ Valg registrert: ${choiceLetter}) ${choiceTitle}\n\nDitt valg er sendt til admin og lagret i systemet!`);
                
                const successEl = document.createElement('div');
                successEl.innerHTML = '‚úÖ Valg registrert!';
                successEl.style.cssText = 'font-size: 0.8rem; color: #155724; margin-top: 0.5rem; font-weight: bold;';
                choiceEl.appendChild(successEl);
                
                // Disable further clicks
                choiceEl.style.pointerEvents = 'none';
                choiceEl.style.opacity = '0.8';
                
                addNotification(`‚úÖ ${playerName} valgte ${choiceLetter}: ${choiceTitle}`);
                
            } catch (error) {
                console.error('Error sending choice:', error);
                
                if (choiceEl.contains(loadingEl)) {
                    choiceEl.removeChild(loadingEl);
                }
                
                choiceEl.style.backgroundColor = '#f8d7da';
                choiceEl.style.borderColor = '#dc3545';
                
                alert('‚ùå Feil ved sending av valg: ' + error.message + '\n\nPr√∏v igjen eller kontakt admin.');
                
                // Reset styling after 3 seconds
                setTimeout(() => {
                    choiceEl.style.backgroundColor = originalBg;
                    choiceEl.style.borderColor = '';
                }, 3000);
            }
        }
        function updateConnectionStatus(status, message) {
            const statusEl = document.getElementById('connection-status');
            statusEl.className = `connection-status ${status}`;
            
            const icons = {
                loading: 'üîÑ',
                connected: '‚úÖ',
                error: '‚ùå'
            };
            
            statusEl.innerHTML = `${icons[status]} ${message}`;
            
            // Auto-hide after 5 seconds if connected
            if (status === 'connected') {
                setTimeout(() => {
                    statusEl.style.opacity = '0.7';
                    statusEl.style.transform = 'scale(0.9)';
                }, 5000);
            }
        }

        // DEBUG: Test the fixed Google Apps Script
        window.debugFixedScript = function() {
            console.log('üîß DEBUG: Testing fixed Google Apps Script...');
            
            // Test getCurrentScenario specifically
            const callbackName = 'debugFixedCallback_' + Date.now();
            const script = document.createElement('script');
            
            window[callbackName] = function(response) {
                document.head.removeChild(script);
                delete window[callbackName];
                
                console.log('üîç Fixed Script Response:');
                console.log('  Type:', typeof response);
                console.log('  Keys:', Object.keys(response));
                console.log('  Status:', response.status);
                console.log('  Message:', response.message);
                console.log('  Data:', response.data);
                console.log('  Full Response:', response);
                
                if (response.data) {
                    console.log('üéØ Scenario Data Found:');
                    console.log('  ID:', response.data.id);
                    console.log('  Title:', response.data.title);
                    console.log('  Tasks:', response.data.tasks);
                    console.log('  Choices:', response.data.choices);
                }
            };
            
            script.onerror = function() {
                document.head.removeChild(script);
                delete window[callbackName];
                console.log('‚ùå DEBUG: Fixed script test failed');
            };
            
            // Test the exact same URL
            const testUrl = GOOGLE_SHEETS_URL + '?callback=' + callbackName + '&action=getCurrentScenario';
            console.log('üîó Testing URL:', testUrl);
            
            script.src = testUrl;
            document.head.appendChild(script);
        };

        // DEBUG: Test different actions to see what exists
        window.testGoogleAppsScriptActions = function() {
            const actions = ['getPlayers', 'getCurrentScenario', 'getScenarios', 'ping'];
            
            actions.forEach((action, index) => {
                setTimeout(() => {
                    console.log(`üß™ Testing action: ${action}`);
                    
                    const callbackName = `testAction_${action}_${Date.now()}`;
                    const script = document.createElement('script');
                    
                    window[callbackName] = function(response) {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        
                        console.log(`‚úÖ Action "${action}" result:`, response);
                    };
                    
                    script.onerror = function() {
                        document.head.removeChild(script);
                        delete window[callbackName];
                        console.log(`‚ùå Action "${action}" failed`);
                    };
                    
                    script.src = GOOGLE_SHEETS_URL + '?callback=' + callbackName + '&action=' + action;
                    document.head.appendChild(script);
                }, index * 2000); // 2 second delay between tests
            });
        };

        // DEBUG: Manual test function for scenario loading
        window.debugScenarioLoading = function() {
            console.log('üîß DEBUG: Manual scenario loading test...');
            
            const callbackName = 'debugCallback_' + Date.now();
            const script = document.createElement('script');
            
            window[callbackName] = function(response) {
                document.head.removeChild(script);
                delete window[callbackName];
                
                console.log('üîç DEBUG Response type:', typeof response);
                console.log('üîç DEBUG Response keys:', Object.keys(response));
                console.log('üîç DEBUG Full response:', response);
                
                if (response.data) {
                    console.log('üîç DEBUG Response.data type:', typeof response.data);
                    console.log('üîç DEBUG Response.data:', response.data);
                }
            };
            
            script.onerror = function() {
                document.head.removeChild(script);
                delete window[callbackName];
                console.log('‚ùå DEBUG: Script loading failed');
            };
            
            script.src = GOOGLE_SHEETS_URL + '?callback=' + callbackName + '&action=getCurrentScenario';
            document.head.appendChild(script);
        };

        // STEG 3: Load scenario from Google Sheets - FIXED
        function loadScenarioFromSheets() {
            console.log('üîÑ Loading scenario from Google Sheets...');
            
            const callbackName = 'loadScenarioCallback_' + Date.now();
            const script = document.createElement('script');
            
            window[callbackName] = function(response) {
                document.head.removeChild(script);
                delete window[callbackName];
                
                console.log('üé≤ Scenario response:', response);
                
                // Check if we got the wrong response (choices instead of scenario)
                if (response && response.status === 'success' && response.message === 'Choice recorded successfully') {
                    console.log('‚ö†Ô∏è Got choices response instead of scenario - Google Apps Script routing issue');
                    addNotification(`‚ö†Ô∏è Scenario loading har routing-problem i Google Apps Script`);
                    return;
                }
                
                if (response && response.status === 'success' && response.data) {
                    // Update gameState with loaded scenario
                    gameState.currentScenario = {
                        id: response.data.id,
                        title: response.data.title || 'Nytt Scenario',
                        background: response.data.background || '',
                        deadline: response.data.deadline || '',
                        tasks: response.data.tasks || [],
                        choices: response.data.choices || {},
                        results: response.data.results || {}
                    };
                    
                    console.log('‚úÖ Scenario loaded from Google Sheets:', gameState.currentScenario.title);
                    console.log('üìã Scenario data:', gameState.currentScenario);
                    
                    // Update UI
                    renderScenario();
                    updateStats();
                    
                    addNotification(`üé≤ Scenario oppdatert: ${gameState.currentScenario.title}`);
                } else if (response && response.status === 'success' && !response.data) {
                    console.log('‚ÑπÔ∏è No scenario found in Google Sheets - database empty');
                    gameState.currentScenario = null;
                    renderScenario();
                    updateStats();
                    addNotification(`‚ÑπÔ∏è Ingen aktive scenarioer i Google Sheets database`);
                } else {
                    console.log('‚ùå Invalid scenario response:', response);
                    addNotification(`‚ùå Ugyldig scenario-respons fra Google Sheets`);
                }
            };
            
            script.onerror = function() {
                document.head.removeChild(script);
                delete window[callbackName];
                console.log('‚ùå Failed to load scenario from Google Sheets');
                addNotification(`‚ùå Kunne ikke laste scenario fra Google Sheets.`);
            };
            
            script.src = GOOGLE_SHEETS_URL + '?callback=' + callbackName + '&action=getCurrentScenario';
            document.head.appendChild(script);
            
            // Timeout after 15 seconds
            setTimeout(() => {
                if (document.head.contains(script)) {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    console.log('‚ùå Scenario loading timeout');
                }
            }, 15000);
        }

        function loadPlayerBreakdownsFromSheets() {
    const sheetsUrl = localStorage.getItem('tripletex_sheets_url') || 
                     'https://script.google.com/a/macros/visma.com/s/AKfycby8O4wZLmoG6e-W1w9GVZUBwlRkhNMQyKZnBhEIfGiyUM_yNWwTNnV3-dP0kJ5H9HNUJQ/exec';
    
    const callbackName = 'loadBreakdownsCallback_' + Date.now();
    const script = document.createElement('script');
    
    window[callbackName] = function(response) {
        document.head.removeChild(script);
        delete window[callbackName];
        
        if (response && response.status === 'success') {
            gameState.playerBreakdowns = response.data;
            console.log('‚úÖ Player breakdowns loaded from Google Sheets:', Object.keys(response.data).length, 'players');
            
            // Force re-render leaderboard med penalties
            renderLeaderboard();
        } else {
            console.log('‚ÑπÔ∏è No player breakdowns found in Google Sheets');
        }
    };
    
    script.onerror = function() {
        document.head.removeChild(script);
        delete window[callbackName];
        console.log('‚ùå Failed to load player breakdowns from Google Sheets');
    };
    
    script.src = sheetsUrl + '?callback=' + callbackName + '&action=getPlayerBreakdowns';
    document.head.appendChild(script);
}

        // STEG 2: Load players from Google Sheets - ALWAYS use Sheets data if available
        function loadPlayersFromSheets() {
            console.log('üîÑ Loading players from Google Sheets...');
            updateConnectionStatus('loading', 'Laster spillere...');
            
            const callbackName = 'loadPlayersCallback_' + Date.now();
            const script = document.createElement('script');
            
            window[callbackName] = function(response) {
                document.head.removeChild(script);
                delete window[callbackName];
                
                console.log('üìä Players response:', response);
                
                if (response && response.status === 'success' && response.data && response.data.length > 0) {
                    // ALWAYS use data from Google Sheets - it's our database!
                    gameState.players = response.data.map((player, index) => ({
                        name: player.name || `Spiller ${index + 1}`,
                        company: player.company || player.name || `Selskap ${index + 1}`,
                        businessValue: parseInt(player.businessValue) || 500000,
                        rank: parseInt(player.rank) || (index + 1)
                    }));
                    
                    // Sort by business value and update ranks
                    gameState.players.sort((a, b) => b.businessValue - a.businessValue);
                    gameState.players.forEach((player, index) => {
                        player.rank = index + 1;
                    });
                    
                    console.log('‚úÖ Players loaded from Google Sheets database:', gameState.players.length, 'players');
                    console.log('üìã Player data:', gameState.players);
                    
                    // Update UI
                    renderLeaderboard();
                    updateStats();
                    updateConnectionStatus('connected', 'Live data fra Sheets');
                    
                    addNotification(`üìä ${gameState.players.length} spillere lastet fra Google Sheets database!`);
                } else {
                    console.log('‚ÑπÔ∏è No players found in Google Sheets - database is empty');
                    updateConnectionStatus('connected', 'Tilkoblet (database tom)');
                    addNotification(`‚ÑπÔ∏è Google Sheets database er tom. Legg til spillere i admin panel.`);
                }
                // Also load breakdowns from localStorage
const savedBreakdowns = localStorage.getItem('tripletex_player_breakdowns');
if (savedBreakdowns) {
    gameState.playerBreakdowns = JSON.parse(savedBreakdowns);
}
            };
            
            script.onerror = function() {
                document.head.removeChild(script);
                delete window[callbackName];
                updateConnectionStatus('error', 'Feil ved lasting av spillere');
                console.log('‚ùå Failed to load players from Google Sheets');
                addNotification(`‚ùå Kunne ikke laste spillerdata fra Google Sheets database.`);
            };
            
            script.src = GOOGLE_SHEETS_URL + '?callback=' + callbackName + '&action=getPlayers';
            document.head.appendChild(script);
            
            // Timeout after 15 seconds
            setTimeout(() => {
                if (document.head.contains(script)) {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    updateConnectionStatus('error', 'Timeout ved lasting av spillere');
                    console.log('‚ùå Players loading timeout');
                    addNotification(`‚è∞ Timeout ved lasting fra Google Sheets database.`);
                }
            }, 15000);
        }

        // Test connection to Google Sheets
        function testGoogleSheetsConnection() {
            console.log('üîÑ Testing Google Sheets connection...');
            updateConnectionStatus('loading', 'Tester forbindelse...');
            
            const callbackName = 'testCallback_' + Date.now();
            const script = document.createElement('script');
            
            window[callbackName] = function(response) {
                document.head.removeChild(script);
                delete window[callbackName];
                
                console.log('üì° Google Sheets response:', response);
                
                if (response && response.status === 'success') {
                    updateConnectionStatus('connected', 'Tilkoblet Google Sheets');
                    console.log('‚úÖ Google Sheets connection successful');
                } else {
                    updateConnectionStatus('error', 'Forbindelsesfeil');
                    console.log('‚ùå Google Sheets connection failed:', response);
                }
            };
            
            script.onerror = function() {
                document.head.removeChild(script);
                delete window[callbackName];
                updateConnectionStatus('error', 'Kan ikke n√• Google Sheets');
                console.log('‚ùå Google Sheets network error');
            };
            
            // Test with a simple ping - try getPlayers action instead of ping
            script.src = GOOGLE_SHEETS_URL + '?callback=' + callbackName + '&action=getPlayers';
            document.head.appendChild(script);
            
            // Timeout after 15 seconds
            setTimeout(() => {
                if (document.head.contains(script)) {
                    document.head.removeChild(script);
                    delete window[callbackName];
                    updateConnectionStatus('error', 'Forbindelse timeout');
                    console.log('‚ùå Google Sheets connection timeout');
                }
            }, 15000);
        }

        // Game state with real companies
let gameState = {
    players: [], // TOM
    currentScenario: null, // NULL
    notifications: [],
    playerBreakdowns: {}
};

        // Navigation functionality
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                
                // Remove active class from all links
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                e.target.classList.add('active');
                
                // Hide all sections
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.add('hidden');
                });
                
                // Show selected section
                const targetSection = e.target.getAttribute('data-section');
                document.getElementById(targetSection).classList.remove('hidden');
            });
        });

        // Render functions
function renderLeaderboard() {
    const container = document.getElementById('leaderboard-content');
    
    if (!gameState.players || gameState.players.length === 0) {
        container.innerHTML = '<p>Ingen spillere registrert enn√•.</p>';
        return;
    }

    let html = '';
    gameState.players.forEach((player, index) => {
        const rankClass = index === 0 ? 'gold' : index === 1 ? 'silver' : index === 2 ? 'bronze' : '';
        
        // Check for penalties to display
        const playerBreakdown = gameState.playerBreakdowns[player.name];
        let penaltyInfo = '';
        
        if (playerBreakdown && playerBreakdown.penalties && playerBreakdown.penalties.length > 0) {
            const penalties = playerBreakdown.penalties;
            const totalPenalties = penalties.reduce((sum, penalty) => sum + Number(penalty.value), 0);
            const latestPenalty = penalties[penalties.length - 1];
            
            penaltyInfo = `
                <div style="font-size: 0.8rem; color: #dc3545; margin-top: 0.3rem;">
                    <strong>Straffer:</strong> ${penalties.length} aktive (${totalPenalties.toLocaleString()} NOK totalt)<br>
                    <strong>Siste:</strong> ${latestPenalty.type} (${latestPenalty.value.toLocaleString()} NOK)
                </div>
            `;
        }
        
        html += `
            <div class="leaderboard-item" 
                 onclick="showPlayerBreakdown('${player.name}')" 
                 title="Klikk for √• se ${player.name}'s detaljer"
                 data-player="${player.name}">
                <span class="rank ${rankClass}">${player.rank}</span>
                <div class="player-info">
                    <div class="player-name">${player.name}</div>
                    <div class="player-company">${player.company}</div>
                    ${penaltyInfo}
                </div>
                <span class="business-value">${player.businessValue.toLocaleString()} NOK</span>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

        function showPlayerBreakdown(playerName) {
            // Close any existing breakdown
            const existingBreakdown = document.querySelector('.breakdown.visible');
            if (existingBreakdown) {
                existingBreakdown.classList.remove('visible');
                existingBreakdown.remove();
            }
            
            // Find the player's leaderboard item
            const playerItem = document.querySelector(`[data-player="${playerName}"]`);
            if (!playerItem) return;
            
            // Get breakdown data
            const breakdownData = gameState.playerBreakdowns[playerName];
            if (!breakdownData) {
                // Create default breakdown for players without data
                const defaultBreakdown = {
                    startCapital: 500000,
                    scenarioGains: [],
                    penalties: [],
                    bonuses: []
                };
                const breakdownHTML = createBreakdownHTML(playerName, defaultBreakdown);
                playerItem.insertAdjacentHTML('afterend', breakdownHTML);
                return;
            }
            
            const breakdownHTML = createBreakdownHTML(playerName, breakdownData);
            playerItem.insertAdjacentHTML('afterend', breakdownHTML);
        }

        function createBreakdownHTML(playerName, breakdownData) {
            const totalScenarioGains = breakdownData.scenarioGains.reduce((sum, gain) => sum + Number(gain.value), 0);
            const totalPenalties = breakdownData.penalties.reduce((sum, penalty) => sum + Number(penalty.value), 0);
            const totalBonuses = breakdownData.bonuses.reduce((sum, bonus) => sum + Number(bonus.value), 0);
            const calculatedTotal = Number(breakdownData.startCapital) + totalScenarioGains + totalPenalties + totalBonuses;
            
            return `
                <div class="breakdown visible" id="breakdown-${playerName.replace(/\s+/g, '-')}">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="margin: 0; color: #0066CC;">${playerName}'s Breakdown</h4>
                        <button class="btn" onclick="closeBreakdown(this)" style="width: auto; padding: 0.25rem 0.75rem; font-size: 0.8rem; margin: 0;">‚úï</button>
                    </div>
                    
                    <div class="breakdown-section">
                        <div class="breakdown-title">üí∞ Start Kapital</div>
                        <div class="breakdown-item neutral">
                            <span>√Öpningsbalanse</span>
                            <span>${Number(breakdownData.startCapital).toLocaleString()} NOK</span>
                        </div>
                    </div>
                    
                    ${breakdownData.scenarioGains.length > 0 ? `
                    <div class="breakdown-section">
                        <div class="breakdown-title">üé≤ Scenario Resultater</div>
                        ${breakdownData.scenarioGains.map(gain => {
                            const value = Number(gain.value);
                            const colorClass = value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
                            const sign = value > 0 ? '+' : '';
                            
                            return `
                                <div class="breakdown-item ${colorClass}">
                                    <span>${gain.scenario} - Valg ${gain.choice}) ${gain.choiceTitle || ''}</span>
                                    <span>${sign}${value.toLocaleString()} NOK</span>
                                </div>
                                <div style="font-size: 0.8rem; color: #666; margin-left: 1rem; margin-bottom: 0.5rem;">
                                    <strong>${gain.outcome}</strong>${gain.description ? ` - ${gain.description}` : ''}
                                </div>
                            `;
                        }).join('')}
                        <div class="breakdown-item ${totalScenarioGains > 0 ? 'positive' : totalScenarioGains < 0 ? 'negative' : 'neutral'}" style="font-weight: bold; border-top: 2px solid ${totalScenarioGains > 0 ? '#28a745' : totalScenarioGains < 0 ? '#dc3545' : '#6c757d'}; padding-top: 0.5rem;">
                            <span>Total scenario gevinster</span>
                            <span>${totalScenarioGains > 0 ? '+' : ''}${totalScenarioGains.toLocaleString()} NOK</span>
                        </div>
                    </div>
                    ` : `
                    <div class="breakdown-section">
                        <div class="breakdown-title">üé≤ Scenario Resultater</div>
                        <div class="breakdown-item neutral">
                            <span>Ingen scenario gevinster enn√•</span>
                            <span>0 NOK</span>
                        </div>
                    </div>
                    `}
                    
                    ${breakdownData.penalties.length > 0 ? `
                    <div class="breakdown-section">
                        <div class="breakdown-title">‚ö†Ô∏è Straffer</div>
                        ${breakdownData.penalties.map(penalty => {
                            const value = Number(penalty.value);
                            const colorClass = value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
                            const sign = value > 0 ? '+' : '';
                            
                            return `
                                <div class="breakdown-item ${colorClass}">
                                    <span>${penalty.type} (${penalty.status}) - ${penalty.date}</span>
                                    <span>${sign}${value.toLocaleString()} NOK</span>
                                </div>
                                <div style="font-size: 0.8rem; color: #666; margin-left: 1rem; margin-bottom: 0.5rem;">
                                    ${penalty.reason}
                                </div>
                            `;
                        }).join('')}
                        <div class="breakdown-item ${totalPenalties > 0 ? 'positive' : totalPenalties < 0 ? 'negative' : 'neutral'}" style="font-weight: bold; border-top: 2px solid ${totalPenalties > 0 ? '#28a745' : totalPenalties < 0 ? '#dc3545' : '#6c757d'}; padding-top: 0.5rem;">
                            <span>Total straffer</span>
                            <span>${totalPenalties > 0 ? '+' : ''}${totalPenalties.toLocaleString()} NOK</span>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${breakdownData.bonuses.length > 0 ? `
                    <div class="breakdown-section">
                        <div class="breakdown-title">üéâ Bonuser</div>
                        ${breakdownData.bonuses.map(bonus => {
                            const value = Number(bonus.value);
                            const colorClass = value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral';
                            const sign = value > 0 ? '+' : '';
                            
                            return `
                                <div class="breakdown-item ${colorClass}">
                                    <span>${bonus.type} - ${bonus.date}</span>
                                    <span>${sign}${value.toLocaleString()} NOK</span>
                                </div>
                                <div style="font-size: 0.8rem; color: #666; margin-left: 1rem; margin-bottom: 0.5rem;">
                                    ${bonus.reason}
                                </div>
                            `;
                        }).join('')}
                    </div>
                    ` : ''}
                    
                    <div class="breakdown-total">
                        üìä Total Business Value: ${calculatedTotal.toLocaleString()} NOK
                    </div>
                </div>
            `;
        }

        function closeBreakdown(button) {
            const breakdown = button.closest('.breakdown');
            if (breakdown) {
                breakdown.classList.remove('visible');
                breakdown.remove();
            }
        }

        // UPDATED renderScenario function with clickable choices
        function renderScenario() {
            const container = document.getElementById('scenario-content');
            
            if (!gameState.currentScenario) {
                container.innerHTML = `
                    <div class="scenario-card">
                        <h2>Ingen aktivt scenario</h2>
                        <p>Neste scenario kommer snart! Hold deg oppdatert p√• Dashboard.</p>
                        <p><em>Scenarioer styres av admin og oppdateres her n√•r de er aktive.</em></p>
                    </div>
                `;
                return;
            }

            const scenario = gameState.currentScenario;
            const deadline = scenario.deadline ? new Date(scenario.deadline) : null;
            const now = new Date();
            const timeLeft = deadline ? deadline - now : 0;
            const isExpired = timeLeft <= 0;
            
            let deadlineHtml = '';
            if (deadline && !isExpired) {
                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                
                const urgentClass = timeLeft < 24 * 60 * 60 * 1000 ? 'urgent' : '';
                deadlineHtml = `
                    <div class="scenario-deadline ${urgentClass}">
                        ‚è∞ Deadline: ${days}d ${hours}t ${minutes}m igjen
                    </div>
                `;
            } else if (deadline && isExpired) {
                deadlineHtml = `
                    <div class="scenario-deadline urgent">
                        ‚è∞ Deadline passert - venter p√• resultater
                    </div>
                `;
            }

            // Build tasks HTML if available
            let tasksHtml = '';
            if (scenario.tasks && scenario.tasks.length > 0) {
                tasksHtml = '<div class="scenario-tasks"><h3>üìã Obligatoriske Oppgaver:</h3>';
                
                scenario.tasks.forEach(task => {
                    tasksHtml += `
                        <div class="task-display">
                            <div class="task-number">${task.number}</div>
                            <div class="task-content">
                                <div class="task-title">${task.title}</div>
                                <div class="task-description">${task.description}</div>
                                <div class="task-rewards">
                                    ${task.reward ? `<div class="task-reward">‚úÖ ${task.reward}</div>` : ''}
                                    ${task.penalty ? `<div class="task-penalty">‚ùå ${task.penalty}</div>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                });
                tasksHtml += '</div>';
            }

            // Build choices HTML if available
let choicesHtml = '';
const hasResults = scenario.results && Object.keys(scenario.results).length > 0;
if (scenario.choices && Object.keys(scenario.choices).length > 0 && !hasResults) {
                choicesHtml = '<div class="scenario-choices"><h3>üìã Valgalternativer:</h3>';
                
                Object.entries(scenario.choices).forEach(([key, choice]) => {
                    // Handle both string choices and object choices
                    if (typeof choice === 'string') {
                        choicesHtml += `
                            <div class="choice-display">
                                <div class="choice-letter">${key})</div>
                                <div class="choice-content">
                                    <div class="choice-title">${choice}</div>
                                </div>
                            </div>
                        `;
                    } else {
                        choicesHtml += `
                            <div class="choice-display">
                                <div class="choice-letter">${key})</div>
                                <div class="choice-content">
                                    <div class="choice-title">${choice.title || choice}</div>
                                    ${choice.cost ? `<div class="choice-cost">üí∞ ${choice.cost}</div>` : ''}
                                    ${choice.potential ? `<div class="choice-potential">üéØ ${choice.potential}</div>` : ''}
                                    ${choice.odds ? `<div class="choice-odds">üé≤ ${choice.odds}</div>` : ''}
                                </div>
                            </div>
                        `;
                    }
                });
                choicesHtml += '</div>';
                
                if (!isExpired) {
                    choicesHtml += `
                        <div class="scenario-note">
                            <p><strong>üìù Hvordan delta:</strong></p>
                            <p>Klikk p√• ditt √∏nskede valg for √• registrere det automatisk!</p>
                        </div>
                    `;
                } else {
                    choicesHtml += `
                        <div class="scenario-note">
                            <p><strong>‚è∞ Valg-periode avsluttet</strong></p>
                            <p>Venter p√• business-resultater...</p>
                        </div>
                    `;
                }
            }

            // Build results HTML if available - Business results only (no dice details)
            let resultsHtml = '';
            if (scenario.results && Object.keys(scenario.results).length > 0) {
                resultsHtml = `
                    <div class="scenario-results">
                        <h3>üéä Scenario Resultater!</h3>
                        <div class="results-grid">
                `;
                
                Object.entries(scenario.results).forEach(([playerName, result]) => {
                    resultsHtml += `
                        <div class="result-item">
                            <div class="result-player">${playerName}</div>
                            <div class="result-choice">Valg: ${result.choice}) ${result.choiceTitle || result.choice}</div>
                            <div class="result-outcome">${result.outcome}</div>
                            ${result.description ? `<div style="font-size: 0.9rem; color: #666; margin: 0.5rem 0;">${result.description}</div>` : ''}
                            <div class="result-value ${result.valueChange >= 0 ? 'positive' : 'negative'}">
                                ${result.valueChange >= 0 ? '+' : ''}${result.valueChange.toLocaleString()} NOK
                            </div>
                        </div>
                    `;
                });
                
                resultsHtml += `
                        </div>
                        <div class="scenario-note">
                            <p><strong>üíº Neste steg:</strong> Implementer effektene i ditt Tripletex-regnskap!</p>
                        </div>
                    </div>
                `;
            }

            // Combine all HTML parts
            container.innerHTML = `
                <div class="scenario-card">
                    <h2>${scenario.title}</h2>
                    ${scenario.background ? `<p>${scenario.background}</p>` : 
                      scenario.description ? `<p>${scenario.description}</p>` : ''}
                    ${deadlineHtml}
                    ${tasksHtml}
                    ${choicesHtml}
                    ${resultsHtml}
                </div>
            `;
            
            // Make choices clickable after rendering
            setTimeout(() => {
                makeChoicesClickable();
            }, 100);
        }

        function updateStats() {
            // Update dashboard stats
            document.getElementById('total-players').textContent = gameState.players.length;
            
            if (gameState.players.length > 0) {
                const leader = gameState.players[0];
                document.getElementById('current-leader').textContent = leader.name.split(' ')[0];
                
                const avgValue = gameState.players.reduce((sum, p) => sum + p.businessValue, 0) / gameState.players.length;
                document.getElementById('avg-value').textContent = avgValue.toLocaleString();
            }

            // Update scenario status
            const scenarioStatusEl = document.getElementById('scenario-status');
            if (gameState.currentScenario) {
                const deadline = gameState.currentScenario.deadline ? new Date(gameState.currentScenario.deadline) : null;
                const now = new Date();
                
                if (gameState.currentScenario.results) {
                    scenarioStatusEl.textContent = 'Resultater klar';
                } else if (deadline && deadline < now) {
                    scenarioStatusEl.textContent = 'Venter resultater';
                } else if (deadline) {
                    scenarioStatusEl.textContent = 'Aktiv';
                } else {
                    scenarioStatusEl.textContent = 'Planlagt';
                }
            } else {
                scenarioStatusEl.textContent = 'Ingen aktive';
            }
        }

        function addNotification(message, type = 'info') {
            gameState.notifications.unshift({
                message,
                type,
                timestamp: new Date(),
                id: Date.now()
            });
            renderNotifications();
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                gameState.notifications = gameState.notifications.filter(n => n.id !== gameState.notifications[0].id);
                renderNotifications();
            }, 10000);
        }

        function renderNotifications() {
            const container = document.getElementById('notifications');
            
            if (gameState.notifications.length === 0) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            gameState.notifications.slice(0, 3).forEach(notification => {
                html += `
                    <div class="notification">
                        üì¢ ${notification.message}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Functions that admin panel can call to update this platform
        window.updateGameData = function(newData) {
            if (newData.players) {
                gameState.players = newData.players;
                renderLeaderboard();
                updateStats();
            }
            if (newData.playerBreakdowns) {
                gameState.playerBreakdowns = newData.playerBreakdowns;
            }
            if (newData.scenario) {
                gameState.currentScenario = newData.scenario;
                renderScenario();
            }
            if (newData.notification) {
                addNotification(newData.notification.message, newData.notification.type);
            }
        };

        // Auto-refresh countdown timer every minute
function startAutoRefresh() {
    setInterval(() => {
        if (gameState.currentScenario && gameState.currentScenario.deadline) {
            renderScenario(); // Updates countdown
            updateStats(); // Updates scenario status
        }
        
        // Auto-refresh scenario data every 2 minutes to check for new results
        loadScenarioFromSheets();
    }, 120000); // Every 2 minutes (changed from 60000)
}

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Test Google Sheets connection first, then load data
            testGoogleSheetsConnection();
            
            // Load real data from Google Sheets after a short delay
            setTimeout(() => {
                loadPlayersFromSheets();
                loadScenarioFromSheets(); // STEG 3: Also load scenario
            }, 2000);
                setTimeout(() => {
        loadPlayerBreakdownsFromSheets();
    }, 4000);
            renderLeaderboard();
            renderScenario();
            updateStats();
            startAutoRefresh(); // Start countdown timer
            
            // Welcome notification
            addNotification('Velkommen til Suppa Business League! Klikk p√• spillere for √• se detaljer. üéâ');
        });
    </script>
</body>
</html>
