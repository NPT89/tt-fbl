name: Update Dashboard Data via Proxy
on:
  schedule:
    - cron: '0 8,12,16 * * 1-5'  # 08:00, 12:00, 16:00 på hverdager (UTC)
  workflow_dispatch:  # Manual trigger

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Fetch data via Proxy
        run: |
          echo "🚀 Henter data via Netlify proxy..."
          
          # Definer proxy URL (erstatt med din Netlify URL)
          PROXY_URL="https://chimerical-meerkat-68dc28.netlify.app"
          
          # Hent data for alle agenter
          agents=("simen.froyhaug" "jathushiga.suth" "elena.myhre")
          
          for agent in "${agents[@]}"; do
            echo "📊 Henter data for: $agent"
            
            curl -f "$PROXY_URL/api/agent-data?agent=$agent" \
              -H "Accept: application/json" \
              -o "${agent}.json" || echo "⚠️ Feil ved henting av $agent"
            
            # Validér JSON
            if jq . "${agent}.json" > /dev/null 2>&1; then
              echo "✅ Gyldig JSON for $agent"
              # Vis første linje for debugging
              echo "📄 Data preview: $(jq -r '.agent.name // "Unknown"' "${agent}.json")"
            else
              echo "❌ Ugyldig JSON for $agent"
              rm -f "${agent}.json"
            fi
          done
      
      - name: Create master data file
        run: |
          echo "📊 Lager master data fil..."
          
          # Start master fil
          cat > all-agents.json << EOF
          {
            "lastUpdated": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)",
            "source": "Netlify Proxy",
            "agents": {
          EOF
          
          # Legg til alle agent-filer
          first=true
          for file in *.json; do
            if [[ "$file" != "all-agents.json" && -f "$file" ]]; then
              if [[ "$first" == "false" ]]; then
                echo "," >> all-agents.json
              fi
              agent_name=$(basename "$file" .json)
              echo "    \"$agent_name\": " >> all-agents.json
              cat "$file" >> all-agents.json
              first=false
            fi
          done
          
          # Avslutt master fil
          cat >> all-agents.json << EOF
            }
          }
          EOF
          
          echo "✅ Master data fil opprettet"
          echo "📊 Total agents: $(jq '.agents | keys | length' all-agents.json)"
      
      - name: Commit and push changes
        run: |
          # Konfigurer git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions Proxy Bot"
          
          # Legg til alle JSON-filer
          git add *.json
          
          # Sjekk om det er endringer
          if git diff --staged --quiet; then
            echo "📝 Ingen endringer i data"
          else
            echo "🔄 Endringer funnet, committer..."
            git commit -m "🤖 Auto-update via proxy - $(date -u '+%Y-%m-%d %H:%M UTC')"
            git push
            echo "✅ Data oppdatert og pushet til GitHub"
          fi
      
      - name: Summary
        run: |
          echo "📈 Proxy Update Summary:"
          echo "- Workflow kjørt: $(date -u '+%Y-%m-%d %H:%M UTC')"
          echo "- Proxy URL: https://YOUR-SITE-NAME.netlify.app"
          echo "- Agent files created:"
          ls -la *.json || echo "  No JSON files found"
          echo ""
          echo "🌐 Dashboard URLs:"
          echo "- https://npt89.github.io/tt-fbl/dashboard/auto.html"
          echo "- Data: https://raw.githubusercontent.com/npt89/tt-fbl/main/simen.froyhaug.json"
