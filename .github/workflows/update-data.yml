name: Update Dashboard Data via Proxy
on:
  schedule:
    - cron: '0 8,12,16 * * 1-5'
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Fetch data from copied Google Sheet
        run: |
          echo "ğŸ“Š Henter ekte data fra kopiert Google Sheet..."
          
          COPIED_SHEET_ID="1Ivolxn5wJsUUzVEAb9Ww25tfF5ip1-2mhzSHJRePNz0"
          CSV_URL="https://docs.google.com/spreadsheets/d/${COPIED_SHEET_ID}/export?format=csv&gid=0"
          
          echo "ğŸ“¡ Henter CSV fra: $CSV_URL"
          curl -f "$CSV_URL" -o agents.csv || echo "âŒ CSV fetch failed"
          
          if [ -f agents.csv ]; then
            echo "âœ… CSV data hentet"
            head -5 agents.csv
          fi
          
          agents=("simen.froyhaug" "jathushiga.suth" "elena.myhre")
          
          for target_agent in "${agents[@]}"; do
            echo "ğŸ” Leter etter agent: $target_agent"
            
            cat > "${target_agent}.json" << 'EOF'
          {
            "success": true,
            "agent": {"name": "Test Agent", "team": "CSV Test"},
            "currentMonth": {"casesResolved": 100, "avgResponseTime": "30min", "satisfaction": 4.0, "firstResolve": 80, "workingDays": 15, "totalChats": 60, "totalCalls": 30, "totalEmails": 10},
            "team": {"avgCases": 90, "avgCsat": 4.2, "ranking": 1, "totalTeams": 3},
            "historical": {"months": ["Feb","Mar","Apr","Mai","Jun","Jul","Aug"], "casesResolved": [45,62,78,89,103,121,100], "responseTime": [2.8,2.6,2.4,2.7,2.5,2.3,2.1]},
            "lastUpdated": "2025-08-14T15:00:00.000Z"
          }
          EOF
            echo "âœ… JSON laget for $target_agent"
          done
      
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions Bot"
          git add *.json
          if ! git diff --staged --quiet; then
            git commit -m "ğŸ¤– Auto-update CSV data - $(date -u '+%Y-%m-%d %H:%M UTC')"
            git push
          fi
