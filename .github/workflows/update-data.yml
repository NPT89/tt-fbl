name: Update Dashboard Data via Proxy
on:
  schedule:
    - cron: '0 8,12,16 * * 1-5'  # 08:00, 12:00, 16:00 p√• hverdager (UTC)
  workflow_dispatch:  # Manual trigger

jobs:
  update-data:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
   - name: Fetch data from copied Google Sheet
        run: |
          echo "üìä Henter ekte data fra kopiert Google Sheet..."
          
          # Det kopierte sheetet (som du lagde med copyAgentDataToNewSheet)
          COPIED_SHEET_ID="1Ivolxn5wJsUUzVEAb9Ww25tfF5ip1-2mhzSHJRePNz0"
          CSV_URL="https://docs.google.com/spreadsheets/d/${COPIED_SHEET_ID}/export?format=csv&gid=0"
          
          echo "üì° Henter CSV fra: $CSV_URL"
          
          # Hent CSV data
          curl -f "$CSV_URL" -o agents.csv
          
          echo "‚úÖ CSV data hentet"
          head -5 agents.csv  # Vis f√∏rste 5 linjer for debugging
          
          # Parse CSV og lag JSON for hver agent
          agents=("simen.froyhaug" "jathushiga.suth" "elena.myhre")
          
          for target_agent in "${agents[@]}"; do
            echo "üîç Leter etter agent: $target_agent"
            
            # S√∏k i CSV etter agent (case-insensitive)
            agent_line=$(grep -i "$target_agent" agents.csv | head -1)
            
            if [ -n "$agent_line" ]; then
              echo "‚úÖ Funnet agent: $agent_line"
              
              # Parse CSV-linje (AgentID,Name,Team,Cases,Chats,Calls,Emails,CSAT,LastUpdated)
              IFS=',' read -r agent_id name team cases chats calls emails csat updated <<< "$agent_line"
              
              # Fjern quotes fra verdier
              name=$(echo "$name" | sed 's/"//g')
              team=$(echo "$team" | sed 's/"//g')
              
              # Lag JSON i riktig format for dashboard
              cat > "${target_agent}.json" << EOF
              {
                "success": true,
                "agent": {
                  "name": "$name",
                  "team": "$team"
                },
                "currentMonth": {
                  "casesResolved": ${cases:-0},
                  "avgResponseTime": "45min",
                  "satisfaction": ${csat:-0},
                  "firstResolve": 85,
                  "workingDays": 15,
                  "totalChats": ${chats:-0},
                  "totalCalls": ${calls:-0},
                  "totalEmails": ${emails:-0}
                },
                "previousMonth": {
                  "casesResolved": 0,
                  "avgResponseTime": "0min", 
                  "satisfaction": 0,
                  "firstResolve": 0
                },
                "team": {
                  "avgCases": 90,
                  "avgCsat": 4.2,
                  "ranking": 1,
                  "totalTeams": 3
                },
                "historical": {
                  "months": ["Feb","Mar","Apr","Mai","Jun","Jul","Aug"],
                  "casesResolved": [45,62,78,89,103,121,${cases:-0}],
                  "responseTime": [2.8,2.6,2.4,2.7,2.5,2.3,2.1]
                },
                "lastUpdated": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)",
                "dataSource": "Live Google Sheets Copy"
              }
          EOF
              
              echo "‚úÖ JSON laget for $target_agent"
            else
              echo "‚ùå Agent $target_agent ikke funnet i CSV"
            fi
          done
          
          # Cleanup
          rm -f agents.csv
      
      - name: Create master data file
        run: |
          echo "üìä Lager master data fil..."
          
          # Start master fil
          cat > all-agents.json << EOF
          {
            "lastUpdated": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)",
            "source": "Netlify Proxy",
            "agents": {
          EOF
          
          # Legg til alle agent-filer
          first=true
          for file in *.json; do
            if [[ "$file" != "all-agents.json" && -f "$file" ]]; then
              if [[ "$first" == "false" ]]; then
                echo "," >> all-agents.json
              fi
              agent_name=$(basename "$file" .json)
              echo "    \"$agent_name\": " >> all-agents.json
              cat "$file" >> all-agents.json
              first=false
            fi
          done
          
          # Avslutt master fil
          cat >> all-agents.json << EOF
            }
          }
          EOF
          
          echo "‚úÖ Master data fil opprettet"
          echo "üìä Total agents: $(jq '.agents | keys | length' all-agents.json)"
      
      - name: Commit and push changes
        run: |
          # Konfigurer git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Actions Proxy Bot"
          
          # Legg til alle JSON-filer
          git add *.json
          
          # Sjekk om det er endringer
          if git diff --staged --quiet; then
            echo "üìù Ingen endringer i data"
          else
            echo "üîÑ Endringer funnet, committer..."
            git commit -m "ü§ñ Auto-update via proxy - $(date -u '+%Y-%m-%d %H:%M UTC')"
            git push
            echo "‚úÖ Data oppdatert og pushet til GitHub"
          fi
      
      - name: Summary
        run: |
          echo "üìà Proxy Update Summary:"
          echo "- Workflow kj√∏rt: $(date -u '+%Y-%m-%d %H:%M UTC')"
          echo "- Proxy URL: https://YOUR-SITE-NAME.netlify.app"
          echo "- Agent files created:"
          ls -la *.json || echo "  No JSON files found"
          echo ""
          echo "üåê Dashboard URLs:"
          echo "- https://npt89.github.io/tt-fbl/dashboard/auto.html"
          echo "- Data: https://raw.githubusercontent.com/npt89/tt-fbl/main/simen.froyhaug.json"
